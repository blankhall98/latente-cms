<!-- app/templates/admin/entry_edit.html -->
{% extends "base.html" %}
{% block title %}Editar · {{ entry.slug }} · Latente CMS{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <div class="z2h-brand--badge mb-1">Editor</div>
      <h1 class="h4 m-0">Editar: <span class="text-primary">{{ entry.slug }}</span></h1>
      <div class="text-muted small">
        Tenant #{{ entry.tenant_id }} · Section #{{ entry.section_id }} · Schema v{{ entry.schema_version }}
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline" href="/admin/entries/{{ entry.id }}/preview" target="_blank" rel="noopener">Preview</a>
      <form method="post" action="/admin/entries/{{ entry.id }}/publish">
        <button class="btn btn-cta" type="submit">Publicar</button>
      </form>
    </div>
  </div>

  {% if msg %}<div class="alert alert-success mt-3">{{ msg }}</div>{% endif %}
  {% if err %}<div class="alert alert-danger mt-3">{{ err }}</div>{% endif %}

  <form class="mt-3" method="post" action="/admin/entries/{{ entry.id }}/update" onsubmit="return beforeSubmitFriendly();">
    <!-- Meta -->
    <section class="card z2h-card p-3 p-md-4 mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label class="form-label">Slug</label>
          <input class="form-control" name="slug" value="{{ entry.slug }}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Schema version</label>
          <input class="form-control" type="number" min="1" name="schema_version" value="{{ entry.schema_version }}">
          {% if schema_active %}<div class="form-text">Activo: v{{ schema_active.version }}</div>{% endif %}
        </div>
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="draft" {% if entry.status=='draft' %}selected{% endif %}>draft</option>
            <option value="published" {% if entry.status=='published' %}selected{% endif %}>published</option>
            <option value="archived" {% if entry.status=='archived' %}selected{% endif %}>archived</option>
          </select>
        </div>
      </div>
    </section>

    {% set no_hints = (ui_hints is not defined) or (ui_hints|length == 0) %}

    {% if no_hints %}
      {# ===================== FALLBACK SIN UI_HINTS: EDITOR POR SECCIÓN ===================== #}
      <div class="row g-4">
        <!-- Sidebar -->
        <aside class="col-12 col-lg-3">
          <div class="card z2h-card p-3">
            <div class="fw-semibold mb-2">Contenido</div>

            {# Orden de secciones: usa el del preview si existe; si no, nombra por type #}
            {% set groups = [] %}
            {% if preview_sections_order and preview_sections_order|length > 0 %}
              {% set groups = preview_sections_order %}
            {% else %}
              {% for s in (sections_payload or []) %}
                {% set t = (s.type if s.type is defined else s.get('type')) or 'Section' %}
                {% set _ = groups.append(t) %}
              {% endfor %}
            {% endif %}
            {% if groups|length == 0 %}{% set _ = groups.append('Contenido') %}{% endif %}

            <ol class="list-unstyled m-0" id="editor-toc">
              {% for g in groups %}
                <li class="mb-1">
                  <button type="button" class="btn btn-sm w-100 btn-outline" data-target="#sec-{{ loop.index0 }}">
                    {{ loop.index }}. {{ g }}
                  </button>
                </li>
              {% endfor %}
            </ol>

            <div class="z2h-divider my-3"></div>

            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" id="toggle-json">
              <label class="form-check-label" for="toggle-json">Ver JSON global</label>
            </div>
          </div>
        </aside>

        <!-- Main -->
        <main class="col-12 col-lg-9">
          {% for s in (sections_payload or []) %}
            {% set panel_index = loop.index0 %}
            {% set stype = (s.type if s.type is defined else s.get('type')) or 'Section' %}
            {% set sdata = (s.data if s.data is defined else s.get('data')) or {} %}

            <section id="sec-{{ panel_index }}" class="edit-panel card z2h-card p-3 p-md-4 mb-4" {% if not loop.first %}style="display:none"{% endif %}>
              <h2 class="h5 mb-3">{{ loop.index }}. {{ stype }}</h2>

              <div class="mb-2 text-muted small">
                Editor rápido sin contrato de UI: edita el JSON del bloque (<code>sections[{{ panel_index }}].data</code>).
              </div>

              <textarea class="form-control font-monospace" rows="12" name="json_section_{{ panel_index }}">{{ sdata | tojson(indent=2) }}</textarea>
            </section>
          {% endfor %}

          <!-- JSON Global -->
          <section id="json-view" class="card z2h-card p-3 p-md-4" style="display:none;">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-semibold">Vista JSON (global)</div>
            </div>
            <textarea name="data_json" class="form-control font-monospace" rows="14">{{ entry.data | tojson(indent=2) }}</textarea>
            <div class="form-text">Puedes editar el objeto completo si lo prefieres.</div>
          </section>

          <div class="d-flex gap-2 my-4">
            <a href="/admin/entries?tenant_id={{ entry.tenant_id }}&section_id={{ entry.section_id }}" class="btn btn-owa-outline">Cancelar</a>
            <button class="btn btn-primary" type="submit">Guardar cambios</button>
          </div>
        </main>
      </div>

    {% else %}
      {# ===================== CON UI_HINTS: EDITOR AMIGABLE POR CAMPOS ===================== #}
      <div class="row g-4">
        <!-- Sidebar -->
        <aside class="col-12 col-lg-3">
          <div class="card z2h-card p-3">
            <div class="fw-semibold mb-2">Contenido</div>

            {% set ui_groups = [] %}
            {% for f in ui_hints %}
              {% set g = f.get('section') or 'General' %}
              {% if g not in ui_groups %}{% set _ = ui_groups.append(g) %}{% endif %}
            {% endfor %}

            {% set groups = preview_sections_order if preview_sections_order and preview_sections_order|length > 0 else ui_groups %}
            {% if groups|length == 0 %}{% set _ = groups.append('General') %}{% endif %}

            <ol class="list-unstyled m-0" id="editor-toc">
              {% for g in groups %}
                <li class="mb-1">
                  <button type="button" class="btn btn-sm w-100 btn-outline" data-target="#sec-{{ loop.index0 }}">
                    {{ loop.index }}. {{ g }}
                  </button>
                </li>
              {% endfor %}
            </ol>

            <div class="z2h-divider my-3"></div>

            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="toggle-adv">
              <label class="form-check-label" for="toggle-adv">Mostrar campos técnicos</label>
            </div>

            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" id="toggle-json">
              <label class="form-check-label" for="toggle-json">Ver JSON global</label>
            </div>
          </div>
        </aside>

        <!-- Main -->
        <main class="col-12 col-lg-9">
          {% for g in groups %}
            {% set panel_index = loop.index0 %}
            <section id="sec-{{ panel_index }}" class="edit-panel card z2h-card p-3 p-md-4 mb-4" {% if not loop.first %}style="display:none"{% endif %}>
              <h2 class="h5 mb-3">{{ g }}</h2>

              <div class="row g-3">
                {% for f in ui_hints if (f.get('section') or 'General') == g %}
                  {% set label   = f.get('label') or f.get('name') %}
                  {% set path    = f.get('path') or [] %}
                  {% set pname   = 'f__' + ('__'.join(path)) %}
                  {% set ftype   = f.get('type') or 'string' %}
                  {% set fmt     = f.get('format') or '' %}
                  {% set widget  = f.get('widget') or '' %}
                  {% set val     = values_map.get(f.get('name')) %}
                  {% set items_s = f.get('items') %}
                  {% set is_complex = (ftype == 'object') or (ftype == 'array' and (items_s and (items_s.get('type') != 'string'))) %}

                  {% if not is_complex %}
                    <div class="col-12 {% if ftype in ['string','number','integer'] %}col-md-6{% endif %}">
                      <label class="form-label">{{ label }}</label>

                      {% if f.get('enum') %}
                        <select class="form-select" name="{{ pname }}">
                          {% for opt in f.get('enum') %}
                            <option value="{{ opt }}" {% if val == opt %}selected{% endif %}>{{ opt }}</option>
                          {% endfor %}
                        </select>

                      {% elif ftype == 'boolean' %}
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" name="{{ pname }}" value="true" {% if val %}checked{% endif %}>
                          <label class="form-check-label">Activar</label>
                        </div>

                      {% elif ftype in ['number','integer'] %}
                        <input class="form-control" type="number" step="any" name="{{ pname }}" value="{{ val if val is not none }}">

                      {% elif ftype == 'array' and (items_s and items_s.get('type') == 'string') %}
                        <input class="form-control" name="{{ pname }}" value="{{ (val|join(', ')) if val else '' }}" placeholder="separa con comas">

                      {% elif (fmt == 'image') or ('image' in (widget|lower)) or ('image' in (f.get('name') or '')|lower) %}
                        <div class="input-group">
                          <input class="form-control" name="{{ pname }}" value="{{ val or '' }}" placeholder="URL de la imagen (temporal)">
                          <button class="btn btn-outline-secondary" type="button" data-upload-for="{{ pname }}">Subir imagen</button>
                        </div>
                        <input type="file" class="d-none" accept="image/*" id="up-{{ pname }}">
                        {% if val %}
                          <div class="mt-2">
                            <div class="ratio ratio-16x9 rounded overflow-hidden border">
                              <img src="{{ val }}" alt="preview" class="w-100 h-100" style="object-fit:cover;">
                            </div>
                          </div>
                        {% endif %}

                      {% elif (fmt == 'textarea') or (widget == 'textarea') %}
                        <textarea class="form-control" rows="4" name="{{ pname }}">{{ val or '' }}</textarea>

                      {% else %}
                        <input class="form-control" name="{{ pname }}" value="{{ val or '' }}">
                      {% endif %}

                      {% if f.get('help') %}<div class="form-text">{{ f.get('help') }}</div>{% endif %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>

              {# JSON avanzado por sección (para objetos/arrays<object>) #}
              {% set section_json = {} %}
              {% for f in ui_hints if (f.get('section') or 'General') == g %}
                {% set items_s = f.get('items') %}
                {% if (f.get('type') == 'object') or (f.get('type') == 'array' and (items_s and items_s.get('type') != 'string')) %}
                  {% set section_json = values_map.get(f.get('name')) if values_map.get(f.get('name')) is not none else section_json %}
                {% endif %}
              {% endfor %}

              <div class="mt-3 adv-only" style="display:none;">
                <div class="fw-semibold">JSON avanzado ({{ g }})</div>
                <textarea class="form-control mt-2 font-monospace" rows="10"
                          name="json__{{ g | replace(' ', '') | replace('.', '') | replace('#','') }}_section">{{ section_json | tojson(indent=2) if section_json else '' }}</textarea>
                <div class="form-text">Edita listas de objetos u opciones avanzadas.</div>
              </div>
            </section>
          {% endfor %}

          <!-- JSON Global -->
          <section id="json-view" class="card z2h-card p-3 p-md-4" style="display:none;">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-semibold">Vista JSON (global)</div>
            </div>
            <textarea name="data_json" class="form-control font-monospace" rows="14">{{ entry.data | tojson(indent=2) }}</textarea>
            <div class="form-text">Puedes editar el objeto completo si lo prefieres.</div>
          </section>

          <div class="d-flex gap-2 my-4">
            <a href="/admin/entries?tenant_id={{ entry.tenant_id }}&section_id={{ entry.section_id }}" class="btn btn-owa-outline">Cancelar</a>
            <button class="btn btn-primary" type="submit">Guardar cambios</button>
          </div>
        </main>
      </div>
    {% endif %}
  </form>
</div>

<script>
  // Navegación entre secciones
  document.querySelectorAll('#editor-toc [data-target]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-target');
      document.querySelectorAll('.edit-panel').forEach(p=> p.style.display='none');
      const panel = document.querySelector(id);
      if(panel) panel.style.display='block';
      document.querySelectorAll('#editor-toc [data-target]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  // Switch: avanzados por sección (sólo rama con ui_hints)
  const advSwitch = document.getElementById('toggle-adv');
  if (advSwitch){
    const sync = () => {
      const show = advSwitch.checked;
      document.querySelectorAll('.adv-only').forEach(el => el.style.display = show ? 'block' : 'none');
    };
    advSwitch.addEventListener('change', sync);
    sync();
  }

  // Switch: JSON global
  const jsonSwitch = document.getElementById('toggle-json');
  if (jsonSwitch){
    const syncJson = () => {
      const show = jsonSwitch.checked;
      const node = document.getElementById('json-view');
      if (node){ node.style.display = show ? 'block' : 'none'; }
    };
    jsonSwitch.addEventListener('change', syncJson);
    syncJson();
  }

  // Subir imagen (dummy)
  document.querySelectorAll('[data-upload-for]').forEach(btn=>{
    const name = btn.getAttribute('data-upload-for');
    const hidden = document.getElementById('up-' + name);
    const text = document.querySelector(`[name="${name}"]`);
    if(hidden && text){
      btn.addEventListener('click', ()=> hidden.click());
      hidden.addEventListener('change', ()=>{
        if(hidden.files && hidden.files[0]){
          text.value = hidden.files[0].name; // placeholder (futuro: subir y setear URL)
        }
      });
    }
  });

  // Normalizar booleanos
  function beforeSubmitFriendly(){
    document.querySelectorAll('input.form-check-input[type="checkbox"]').forEach(chk=>{
      if(!chk.checked){ chk.value = ""; }
    });
    return true;
  }
</script>

<style>
  #editor-toc .btn.active { outline: 2px solid var(--border-strong, #c9c9c9); }
  .z2h-json, textarea.font-monospace {
    background: var(--surface-2, #fafafa);
    border: 1px dashed var(--border, #e5e7eb);
    border-radius: 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size: .9rem;
  }
</style>
{% endblock %}










{% extends "base.html" %}
{% block title %}Edit Page - {{ page.title }} - Latente CMS{% endblock %}

{% block content %}
<section class="container my-4"
         id="z2h-edit-root"
         data-tenant="{{ active_tenant.slug|default('') }}"
         data-tenant-id="{{ active_tenant.id|default('') }}"
         data-user-id="{{ user.id|default('') }}"
         data-section-key="{{ page.section_key|default('') }}"
         data-entry-id="{{ page.id|default('') }}"
         data-entry-slug="{{ page.slug|default('') }}"
         data-section-id="{{ page.section_id|default('') }}">

  {% if schema_ui_json is defined and schema_ui_json %}
    <!-- Already JSON-serialized; don't tojson -->
    <script id="z2h-schema-ui" type="application/json">{{ schema_ui_json | safe }}</script>
  {% endif %}

  <!-- Header / toolbar -->
  <header id="z2h-toolbar" class="mb-3" aria-label="Page header actions">
    <div class="z2h-toolbar border rounded-3 p-3 bg-white shadow-sm">
      <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 w-100">
        <div>
          <h1 class="h4 m-0 text-capitalize">{{ page.title }}</h1>
          <div class="z2h-meta row gx-2 gy-1 mt-1">
            <div class="col-auto"><code class="z2h-chip z2h-chip--lg code">/{{ page.slug }}</code></div>
            <div class="col-auto"><span class="z2h-chip z2h-chip--lg">Section: <strong>{{ page.section_name }}</strong></span></div>
            {% set s=(page.status or '')|lower %}
            <div class="col-auto">
              <span id="z2h-status-chip" class="z2h-chip z2h-chip--lg z2h-chip-status {{ s }}">{{ s or 'draft' }}</span>
            </div>
            <div class="col-auto"><span class="z2h-chip z2h-chip--lg">Schema v{{ page.schema_version }}</span></div>
            <div class="col-auto d-none d-sm-inline"><span class="z2h-dot"></span><span class="z2h-save-txt">Saved</span></div>
          </div>
        </div>

        <!-- Polished actions bar (behaviour unchanged) -->
        <div class="btn-toolbar z2h-actions gap-2" role="toolbar" aria-label="Primary & advanced actions">
          <div class="btn-group me-1" role="group" aria-label="Primary actions">
            <button form="z2h-edit-form" class="btn btn-cta" type="submit" id="z2h-save-btn">Save</button>
            <button type="button" class="btn btn-outline" id="z2h-publish-btn" title="Save changes first">Publish</button>
            <a class="btn btn-outline" href="/admin/pages">Cancel</a>
          </div>

          <!-- Advanced Actions dropdown (contains Delivery JSON + Recover) -->
          <div class="btn-group" role="group">
            <button type="button"
                    class="btn btn-outline dropdown-toggle z2h-adv-toggle"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    aria-haspopup="true">
              Advanced Actions
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow z2h-adv-menu" role="menu" aria-label="Advanced actions">
              {% if is_superadmin %}
              <li role="none">
                <a role="menuitem"
                   class="dropdown-item d-none"
                   id="z2h-delivery-btn"
                   target="_blank"
                   rel="noopener">Delivery JSON</a>
              </li>
              {% endif %}
              <li><hr class="dropdown-divider"></li>
              <li role="none">
                <button role="menuitem"
                        type="button"
                        class="dropdown-item d-none"
                        id="z2h-restore-btn"
                        title="Load from published Delivery JSON">Recover</button>
              </li>
            </ul>
          </div>
        </div>
        <!-- /actions -->
      </div>
    </div>
  </header>

  <!-- Divisor suave -->
  <div class="z2h-soft-divider my-3" aria-hidden="true"></div>

  <!-- Local toasts (plus any global from base.html) -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="z2h-toast-host"></div>

  <!-- Editor layout -->
  <form id="z2h-edit-form" class="z2h-editor" method="post" action="" novalidate>
    <!-- Sidebar (fixed style; NOT scrollable inside) -->
    <aside class="z2h-sections-nav" aria-label="Section navigator">
      <div class="mb-2">
        <label class="form-label small mb-1" for="z2h-section-search">Find section</label>
        <input type="search" id="z2h-section-search" class="form-control" placeholder="Type to filter">
      </div>

      <nav id="z2h-side-nav" class="z2h-side-list" role="tablist" aria-orientation="vertical">
        <!-- Item -->
        <button type="button" class="z2h-side-item active" data-panel-id="panel-general" aria-controls="panel-general" role="tab" aria-selected="true">
          <span class="z2h-side-deco" aria-hidden="true"></span>
          <span class="z2h-side-label">General</span>
        </button>

        {% if sections_ui and sections_ui|length > 0 %}
          {% for it in sections_ui %}
            {% set _pid  = 'panel-section-' ~ (it.index if it.index is defined else loop.index0) %}
            <button type="button"
                    class="z2h-side-item"
                    data-panel-id="{{ _pid }}"
                    aria-controls="{{ _pid }}"
                    role="tab"
                    aria-selected="false">
              <span class="z2h-side-deco" aria-hidden="true"></span>
              <span class="z2h-side-label">{{ it.label }}</span>
            </button>
          {% endfor %}
        {% else %}
          <div class="z2h-side-empty">No sections yet</div>
        {% endif %}
      </nav>
    </aside>

    <!-- Main -->
    <main class="z2h-editor-panel">
      <div id="z2h-panels" class="z2h-panels p-3 p-md-4">

        <!-- General -->
        <section id="panel-general" class="z2h-panel" role="tabpanel" tabindex="-1" aria-labelledby="panel-general-label">
          <div class="z2h-panel-head d-flex align-items-center justify-content-between mb-2">
            <h2 id="panel-general-label" class="z2h-panel-title text-uppercase small fw-bold m-0">General</h2>
            <span class="z2h-panel-sub text-muted">Page meta</span>
          </div>

          <div class="card z2h-roomy">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label" for="f-seo-title">SEO Title <span class="text-muted small">(~70)</span></label>
                <input type="text" id="f-seo-title" class="form-control z2h-input-lg z2h-dirty z2h-count" maxlength="120"
                       value="{{ seo_title|default('') }}" placeholder="Up to ~70 chars" data-max="70" autocomplete="off">
                <div class="form-hint"><span data-for="f-seo-title">0</span>/70</div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="f-seo-desc">SEO Description <span class="text-muted small">(~160)</span></label>
                <input type="text" id="f-seo-desc" class="form-control z2h-input-lg z2h-dirty z2h-count" maxlength="240"
                       value="{{ seo_desc|default('') }}" placeholder="Up to ~160 chars" data-max="160" autocomplete="off">
                <div class="form-hint"><span data-for="f-seo-desc">0</span>/160</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Panels per section -->
        {% for it in sections_ui %}
        {% set S = it.sec|default({}, true) %}
        {% set PID = 'panel-section-' ~ (it.index if it.index is defined else loop.index0) %}
        <section id="{{ PID }}"
                 class="z2h-panel d-none"
                 role="tabpanel"
                 tabindex="-1"
                 data-section-index="{{ it.index if it.index is defined else loop.index0 }}"
                 data-section-type="{{ S.type or '' }}"
                 data-section-key="{{ it.key if it.key is defined else '' }}">

          <div class="z2h-panel-head d-flex align-items-center justify-content-between mb-2">
            <h2 class="z2h-panel-title text-uppercase small fw-bold m-0">{{ it.label }}</h2>
            <span class="text-muted">Block editor</span>
          </div>

          <!-- Seed the full section JSON for this panel -->
          <script type="application/json" class="z2h-sec-json">{{ S|tojson }}</script>

          <!-- Auto-Form (Schema-driven) -->
      <div class="card z2h-roomy mb-3">
        <div class="z2h-autoform" data-autoform-for="section"></div>
        <div class="text-muted small" data-autoform-hint style="display:none;">
          This form is generated from the active JSON Schema.
        </div>
      </div>
      {% if it.key == 'projects' %}
      <div class="d-flex justify-content-end">
        <button type="button" class="btn btn-outline" data-projects-draft-btn>Save projects draft (local)</button>
      </div>
      {% endif %}
    </section>
    {% endfor %}

        <!-- Hidden JSON for POST -->
        <textarea name="content_json" id="z2h-content-json" class="d-none" aria-hidden="true"></textarea>

        <!-- Bottom actions (mobile only) -->
        <div class="z2h-actions-bottom d-md-none">
          <a class="btn btn-outline me-auto" href="/admin/pages">Cancel</a>
          <button class="btn btn-cta" type="submit">Save</button>
        </div>
      </div>
    </main>
  </form>

  <!-- Back to Top -->
  <button id="z2h-back-top" class="z2h-back-top" type="button" aria-label="Back to top">Back to Top</button>
</section>

<!-- Component-scoped helpers (small) -->
<style>
  :root{
    --nav-height: 64px;
  }

  /* Toolbar */
  .z2h-toolbar{ background:#fff; }

  /* Actions bar polish */
  .z2h-actions .btn{ border-radius: 10px; }
  .z2h-adv-toggle{ position: relative; }
  .z2h-adv-toggle::after{ transform: translateY(2px); }
  .z2h-adv-menu{ min-width: 220px; border-radius: 12px; border:1px solid var(--border); }
  .z2h-adv-menu .dropdown-item{ font-weight: 600; }
  .z2h-adv-menu .dropdown-item:hover{ background: #f3f6ff; }

  /* Soft divider (gradiente) */
  .z2h-soft-divider{
    height:1px;
    background: linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,.08), rgba(0,0,0,0));
  }

  /* Chips (header only) */
  .z2h-chip{ display:inline-flex; align-items:center; gap:.25rem; padding:.18rem .5rem; border-radius:999px;
             background:#faf8f5; border:1px solid var(--border); color:var(--text-2); font-size:.78rem; }
  .z2h-chip--lg{ padding:.28rem .65rem; font-size:.86rem; }
  .z2h-chip.code{ background:#f6f8ff; border-color:#e3e8ff; color:#334; }
  .z2h-chip-status{ text-transform:uppercase; letter-spacing:.08em; font-weight:700; }
  .z2h-chip-status.published{ background:#eefaf3; border-color:#d6f4e2; color:#175e37; }
  .z2h-chip-status.draft{ background:#fff8ea; border-color:#ffe5b3; color:#7a520c; }
  .z2h-chip-status.archived{ background:#f4f6f8; border-color:#e5e7eb; color:#3b4450; }
  .z2h-dot{ width:.55rem; height:.55rem; border-radius:999px; background:#16a34a; display:inline-block; margin-right:.25rem; }

  /* LAYOUT */
  .z2h-editor{
    display:grid;
    grid-template-columns: minmax(260px, var(--sidebar-w)) minmax(0,1fr);
    gap:18px;
  }
  @media (max-width: 991.98px){
    .z2h-editor{ grid-template-columns: 1fr; }
  }

  /* ======= Side menu (modern, no chips, no inner scroll) ======= */
  .z2h-sections-nav{
    position:sticky;
    top: calc(var(--nav-height) + 16px);
    align-self:start;
    z-index:1;
  }
  .z2h-side-list{
    border:1px solid var(--border);
    background:
      radial-gradient(600px 240px at 10% -10%, rgba(110,158,230,.05), transparent 60%),
      #fff;
    border-radius:14px;
    padding:.6rem;
    box-shadow: 0 10px 26px rgba(0,0,0,.05);
  }
  .z2h-side-item{
    position: relative;
    display:flex; align-items:center;
    gap:.8rem; padding:.78rem .9rem; border:1px solid transparent; width:100%; background:transparent;
    text-align:left; border-radius:12px; margin:.12rem 0; cursor:pointer; color:var(--text-2);
    transition: background-color .22s ease, color .22s ease, border-color .22s ease, transform .18s ease;
  }
  .z2h-side-item .z2h-side-deco{
    width:6px; height:18px; border-radius:6px;
    background: #e8eefc;
    transition: box-shadow .2s ease, background .2s ease;
  }
  .z2h-side-item:hover{
    background:#f8f7f4; color: var(--text-1); border-color:#eee6dc;
    transform: translateX(1px);
  }
  .z2h-side-item.active{
    background:linear-gradient(90deg, #f5f8ff 0%, #ffffff 70%);
    color:#132c55; font-weight:750; border-color:#dbe7ff;
    box-shadow: inset 0 0 0 1px #e9f0ff, 0 4px 10px rgba(37,74,147,.06);
  }
  .z2h-side-item.active .z2h-side-deco{
    background: linear-gradient(180deg, #6e9ee6, #89c2d9);
    box-shadow: 0 0 0 6px rgba(110,158,230,.14);
  }
  .z2h-side-label{
    font-size:.95rem;
    letter-spacing:.01em;
    font-weight:600;
  }
  .z2h-side-empty{ padding:.6rem .9rem; color:var(--text-2); }

  /* Panels / forms */
  .z2h-panel{ outline:none; }
  .z2h-panel-title{ font-size:.95rem; letter-spacing:.08em; }
  .z2h-rep-item{ border:1px dashed var(--border); border-radius:14px; }
  .z2h-roomy{ padding:1.1rem !important; }

  /* Force single-column layout for all form rows (desktop too) */
  .z2h-panel .row.g-3 > [class^="col"],
  .z2h-panel .row.g-3 > [class*=" col"]{
    flex: 0 0 100%;
    max-width: 100%;
  }
  .z2h-autoform .field{
    width: 100%;
  }

  /* Textareas larger by default */
  .textarea-md{ min-height:200px; }
  .textarea-lg{ min-height:260px; }
  .textarea-xl{ min-height:320px; }

  /* Taller inputs for SEO */
  .z2h-input-lg{ height:48px; }

  /* Bottom actions (mobile) */
  .z2h-actions-bottom{ position:sticky; bottom:0; padding:.9rem; display:flex; gap:.6rem; justify-content:end; background:rgba(255,255,255,.95); border-top:1px solid var(--border); }

  /* Invalid */
  .is-invalid{ border-color:#ef4444 !important; box-shadow:0 0 0 .18rem rgba(239,68,68,.16) !important; }

  /* Back to Top */
  .z2h-back-top{
    position: fixed;
    right: 22px;
    bottom: 22px;
    border: 1px solid var(--border);
    background: #fff;
    border-radius: 999px;
    padding: .55rem .9rem;
    box-shadow: 0 8px 22px rgba(0,0,0,.08);
    font-weight: 700;
    font-size: .85rem;
    color: #244d8a;
    opacity: 0;
    pointer-events: none;
    transition: opacity .25s ease, transform .25s ease;
    transform: translateY(8px);
  }
  .z2h-back-top.show{
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }
</style>

{% endblock %}

{% block extra_scripts %}
<script>
/* --- behavior & UX --- */
(function(){
  try{
    if(!sessionStorage.getItem('z2h_edit_scrolled_once')){
      window.scrollTo({top:0,left:0,behavior:'auto'});
      sessionStorage.setItem('z2h_edit_scrolled_once','1');
    }
  }catch(_){}

  (function ensureToast(){
    if(typeof window.z2hFlash === 'function') return;
    const host = document.getElementById('z2h-toast-host');
    window.z2hFlash = function(msg, type){
      const n = document.createElement('div');
      n.className = 'toast align-items-center show';
      n.setAttribute('role','alert'); n.setAttribute('aria-live','assertive'); n.setAttribute('aria-atomic','true');
      n.style.minWidth='240px';
      n.innerHTML = `
        <div class="d-flex">
          <div class="toast-body ${type==='error'?'text-danger':''}">${msg||'Done.'}</div>
          <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>`;
      (host||document.body).appendChild(n);
      setTimeout(()=>{ n.classList.remove('show'); n.addEventListener('transitionend',()=>n.remove(),{once:true}); }, 3000);
    };
  })();

  const root=document.getElementById('z2h-edit-root');
  const nav=document.getElementById('z2h-side-nav');
  const panels=document.querySelectorAll('.z2h-panel');
  const form=document.getElementById('z2h-edit-form');
  const contentJson=document.getElementById('z2h-content-json');
  const entryId=root?.dataset?.entryId;
  const statusDot=document.querySelector('.z2h-dot');
  const saverTxt=document.querySelector('.z2h-save-txt');
  const publishBtn=document.getElementById('z2h-publish-btn');
  const restoreBtn=document.getElementById('z2h-restore-btn');
  const backTop=document.getElementById('z2h-back-top');
  const searchBox=document.getElementById('z2h-section-search');

  function flashOk(m){ if(window.z2hFlash) z2hFlash(m||'Done.','success'); }
  function flashErr(m){ if(window.z2hFlash) z2hFlash(m||'Something went wrong.','error'); }

  let isDirty=false;
  function setDirty(v){
    isDirty=!!v;
    if(statusDot) statusDot.style.background=v?'#f59e0b':'#16a34a';
    if(saverTxt) saverTxt.textContent=v?'Unsaved':'Saved';
    if(publishBtn){ publishBtn.disabled=v; publishBtn.title=v?'Save changes first':'Publish'; }
  }

  function setActiveButtonById(panelId){
    nav.querySelectorAll('.z2h-side-item').forEach(it=>{
      const active = it.getAttribute('data-panel-id')===panelId;
      it.classList.toggle('active', active);
      it.setAttribute('aria-selected', active ? 'true' : 'false');
      if(active){ it.scrollIntoView({block:'nearest', inline:'nearest'}); }
    });
  }
  function showPanel(id, {pushHash=true}={}){
    panels.forEach(p=>p.classList.add('d-none'));
    const el=document.getElementById(id);
    if(el){
      el.classList.remove('d-none');
      try{ el.focus({preventScroll:true}); }catch(_){}
      /* Removed element scroll; we handle page scroll-to-top on menu click */
      setActiveButtonById(id);
      if(pushHash){ history.replaceState(null, '', '#'+id); }
    }
  }
  (function initPanelFromHash(){
    const hash = (location.hash||'').replace('#','');
    const target = hash && document.getElementById(hash) ? hash : 'panel-general';
    showPanel(target, {pushHash:false});
  })();

  /* FIX 1: Side-menu filter restored (keeps "General" visible) */
  function applySideFilter(q){
    const query=(q||'').trim().toLowerCase();
    const items=[...nav.querySelectorAll('.z2h-side-item')];
    items.forEach(btn=>{
      const pid = btn.getAttribute('data-panel-id')||'';
      const label = (btn.querySelector('.z2h-side-label')?.textContent||'').toLowerCase();
      const isGeneral = pid === 'panel-general';
      const match = !query || isGeneral || label.includes(query);
      btn.classList.toggle('d-none', !match);
    });
  }
  searchBox?.addEventListener('input', (e)=>applySideFilter(e.target.value));

  /* FIX 2: Smooth scroll to top when selecting from side-menu */
  nav.addEventListener('click', (e)=>{
    const btn=e.target.closest('.z2h-side-item'); if(!btn) return;
    const pid=btn.getAttribute('data-panel-id');
    if(pid){
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showPanel(pid);
    }
  });

  nav.addEventListener('keydown', (e)=>{
    const items = Array.from(nav.querySelectorAll('.z2h-side-item:not(.d-none)'));
    const current = document.activeElement.closest('.z2h-side-item');
    const idx = items.indexOf(current);
    if(e.key==='ArrowDown'){ e.preventDefault(); (items[idx+1]||items[0])?.focus(); }
    if(e.key==='ArrowUp'){ e.preventDefault(); (items[idx-1]||items[items.length-1])?.focus(); }
    if(e.key==='Enter'){ e.preventDefault(); current?.click(); }
  });

  function setDeep(obj, path, value){
    const parts = path.replace(/\[(\w+)\]/g, '.$1').split('.').filter(Boolean);
    let cur = obj;
    let parent = null;
    let parentKey = null;
    for(let i=0;i<parts.length;i++){
      const key = parts[i];
      const isLast = (i === parts.length - 1);
      const isIndex = /^\d+$/.test(key);
      const nextIsIndex = /^\d+$/.test(parts[i+1] || '');

      if(isIndex){
        const idx = parseInt(key, 10);
        if(!Array.isArray(cur)) {
          if(parent && parentKey !== null){
            parent[parentKey] = [];
            cur = parent[parentKey];
          }else{
            cur = [];
          }
        }
        if(isLast){
          cur[idx] = value;
        }else{
          if(cur[idx] == null || typeof cur[idx] !== 'object') cur[idx] = nextIsIndex ? [] : {};
          parent = cur; parentKey = idx; cur = cur[idx];
        }
      }else{
        if(isLast){
          cur[key] = value;
        }else{
          if(cur[key] == null || typeof cur[key] !== 'object') cur[key] = nextIsIndex ? [] : {};
          parent = cur; parentKey = key; cur = cur[key];
        }
      }
    }
  }
  function getRepItemObject(repItem){
    const obj={};
    repItem.querySelectorAll('[data-k]').forEach(el=>{
      const k=el.getAttribute('data-k'); let v=el.value;
      if(k && k.endsWith(']')) setDeep(obj,k,v);
      else if(k) obj[k]=v;
    });
    return obj;
  }
  function mkRepItem(repeater){
    const last=repeater.querySelector('.z2h-rep-item:last-of-type'); let node;
    if(last){
      node=last.cloneNode(true);
      node.querySelectorAll('input,textarea,select').forEach(el=>el.value='');
    }else{
      node=document.createElement('div'); node.className='z2h-rep-item card p-3 mb-2';
      node.innerHTML=`<div class="row g-2">
        <div class="col"><input type="text" class="form-control z2h-dirty" data-k="label" placeholder="Label"></div>
        <div class="col"><input type="text" class="form-control z2h-dirty" data-k="href" placeholder="Href"></div>
      </div><div class="text-end mt-2"><button type="button" class="btn btn-sm btn-soft-danger z2h-remove">Remove</button></div>`;
    }
    node.querySelectorAll('input,textarea,select').forEach(x=>x.classList.add('z2h-dirty'));
    return node;
  }
  document.addEventListener('click', (e)=>{
    const addBtn=e.target.closest('.z2h-add');
    if(addBtn){
      const name=addBtn.getAttribute('data-repeater');
      const host=addBtn.closest('section').querySelector(`.z2h-repeater[data-repeater="${name}"]`);
      if(host){ host.appendChild(mkRepItem(host)); setDirty(true); }
    }
    const rmBtn=e.target.closest('.z2h-remove');
    if(rmBtn){
      const item=rmBtn.closest('.z2h-rep-item');
      if(item){ item.remove(); setDirty(true); }
    }
  });

  document.querySelectorAll('.z2h-count').forEach(inp=>{
    const max=Number(inp.dataset.max||"0");
    const meter=document.querySelector(`[data-for="${inp.id}"]`);
    function upd(){
      const n=(inp.value||'').trim().length;
      if(meter) meter.textContent=n;
      inp.classList.toggle('is-invalid', max&&n>max);
    }
    inp.addEventListener('input', upd); upd();
  });

  /* Mostrar/armar botones de Delivery/Publish/Recover */
  (function(){
    const tenant=root?.dataset?.tenant||'';
    const section=root?.dataset?.sectionKey||'';
    const slug=root?.dataset?.entrySlug||'';
    const btn=document.getElementById('z2h-delivery-btn');
    const pb=document.getElementById('z2h-publish-btn');
    const rb=document.getElementById('z2h-restore-btn');
    if(tenant && section && slug && btn){
      btn.href=`/delivery/v1/tenants/${tenant}/sections/${encodeURIComponent(section)}/entries/${encodeURIComponent(slug)}`;
      btn.classList.remove('d-none');
      pb?.classList.remove('d-none');
      rb?.classList.remove('d-none');
    }else{
      pb?.classList.remove('d-none');
      rb?.classList.remove('d-none');
    }
  })();

  (function(){
    const publishBtn=document.getElementById('z2h-publish-btn');
    if(!publishBtn) return;

    function setStatusChip(v){
      const chip=document.getElementById('z2h-status-chip');
      if(!chip) return;
      chip.textContent=v;
      chip.classList.remove('published','draft','archived');
      chip.classList.add(v);
    }

    async function callPublish(){
      const entryId  = root.dataset.entryId;
      const tenantId = (root.dataset.tenantId||'').trim();
      const replace  = false; /* standard value (toggle removed) */

      const res = await fetch(`/admin/pages/${entryId}/publish?tenant_id=${encodeURIComponent(tenantId)}`, {
        method:'POST',
        headers:{ 'X-Requested-With':'fetch', 'Content-Type':'application/json' },
        credentials:'same-origin',
        body: JSON.stringify({ replace })
      });
      if(!res.ok){
        let txt=''; try{ txt=await res.text(); }catch(_){}
        throw new Error(txt||'Publish failed');
      }
      return res.json().catch(()=>({}));
    }

    publishBtn.addEventListener('click', async ()=>{
      if(isDirty){ alert('You have unsaved changes. Please press Save before publishing.'); return; }
      const hasSections=document.querySelectorAll('[data-section-index]').length>0;
      if(!hasSections){ alert('This page has no sections. Add content before publishing.'); return; }

      publishBtn.disabled = true;
      publishBtn.setAttribute('aria-busy','true');
      const old = publishBtn.textContent;
      publishBtn.textContent = 'Publishing...';
      try{
        await callPublish();
        setStatusChip('published');
        flashOk('Published successfully.');
        const btn = document.getElementById('z2h-delivery-btn');
        if(btn && btn.href){
          const u = new URL(btn.href, window.location.origin);
          u.searchParams.set('_', Date.now().toString());
          btn.href = u.toString();
        }
      }catch(err){
        flashErr(err?.message||'Publish failed');
      }finally{
        publishBtn.textContent = old;
        publishBtn.disabled = false;
        publishBtn.removeAttribute('aria-busy');
      }
    });
  })();

  let SCHEMA_UI=null;
  (function(){
    try{
      const script=document.getElementById('z2h-schema-ui');
      if(script){ SCHEMA_UI=JSON.parse(script.textContent||'{}'); }
    }catch(_){}
  })();

  async function maybeFetchSchemaUI(){
    if (SCHEMA_UI && Object.keys(SCHEMA_UI).length) return SCHEMA_UI;
    const sectionId = (root?.dataset?.sectionId || '').trim();
    const tenantId  = (root?.dataset?.tenantId  || '').trim();
    if (!sectionId || !tenantId) return null;

    try{
      const url = `/api/v1/schemas/{{ page.section_id|default('') }}/active/raw?tenant_id={{ active_tenant.id|default('') }}`;
      const res = await fetch(url, { headers: { 'X-Requested-With':'fetch' } });
      if (!res.ok) { console.warn('Schema fetch failed:', res.status, url); return null; }
      const j = await res.json();
      if (!j || typeof j !== 'object' || !j.properties) { console.warn('Schema not JSON Schema-like:', j); return null; }
      SCHEMA_UI = j;
      return SCHEMA_UI;
    } catch (e){ console.warn('Schema fetch error:', e); return null; }
  }

  function canonical(x){ return (x ?? '').toString().trim().toLowerCase(); }
  function uiOf(node){ return (node && typeof node==='object' && (node['x-ui']||node['x_ui']||node['ui'])) || {}; }
  function orderKeys(props, ui){
    const keys=Object.keys(props||{});
    const ord=(ui && ui.order)||ui?.['x-order']||[];
    // Common content patterns
    if(keys.includes('title') && keys.includes('text') && keys.includes('image')){
      return ['title','text','image', ...keys.filter(k=>!['title','text','image'].includes(k))];
    }
    if(keys.includes('label') && keys.includes('href')){
      return ['label','href', ...keys.filter(k=>!['label','href'].includes(k))];
    }
    if(keys.includes('left') && keys.includes('middle') && keys.includes('right')){
      return ['left','middle','right', ...keys.filter(k=>!['left','middle','right'].includes(k))];
    }
    // Fallback for common nav pattern when no explicit order is present
    if((!ord || !ord.length) && keys.includes('left') && keys.includes('middle') && keys.includes('right')){
      return ['left','middle','right', ...keys.filter(k=>!['left','middle','right'].includes(k))];
    }
    const ordSet=new Set(ord);
    const rest=keys.filter(k=>!ordSet.has(k));
    return [...ord, ...rest];
  }
  function hasUsefulProps(sub){
    const props = (sub && sub.properties) || {};
    const keys = Object.keys(props);
    if (!keys.length) return false;
    if (keys.length > 1) return true;
    if (props.data && typeof props.data === 'object') return true;
    return false;
  }
  function getSectionsRoot(schemaUI){
    const props = (schemaUI && schemaUI.properties) || {};
    const candidates = ['sections','blocks'];
    for(const k of candidates){
      if (props[k] && (props[k].type==='array' || props[k].items)) {
        return { key:k, node: props[k] };
      }
    }
    for(const [k,v] of Object.entries(props)){
      if (v && (v.type==='array' || v.items)) {
        const items = v.items || {};
        if (Array.isArray(items.oneOf) && items.oneOf.length) return { key:k, node:v };
        if (Array.isArray(items.anyOf) && items.anyOf.length) return { key:k, node:v };
      }
    }
    return { key:'sections', node: props.sections || {} };
  }
  function pickSectionSubschema(schemaUI, sec){
    const { node } = getSectionsRoot(schemaUI);
    const sectionsDef = (node && node.items) || {};
    const variants = sectionsDef.oneOf || sectionsDef.anyOf || [];
    const t = canonical(sec?.type);

    if (Array.isArray(variants) && variants.length){
      let firstUseful=null;
      for (const sub of variants){
        const props=(sub && sub.properties) || {};
        const ui = uiOf(sub);
        const tConst = canonical(props?.type?.const);
        const tEnums = Array.isArray(props?.type?.enum) ? props.type.enum.map(canonical) : [];
        const tTitle = canonical(sub?.title);
        const tLabel = canonical(ui?.label);
        const tAlias = ui?.alias;
        const aliasList = Array.isArray(tAlias) ? tAlias.map(canonical) : (tAlias ? [canonical(tAlias)] : []);

        const matches =
          (t && tConst && t===tConst) ||
          (t && tEnums.includes(t)) ||
          (t && tTitle===t) ||
          (t && tLabel===t) ||
          (t && aliasList.includes(t));

        if (matches) return sub;
        if (!firstUseful && hasUsefulProps(sub)) firstUseful=sub;
      }
      return firstUseful || variants[0];
    }
    return sectionsDef;
  }

  /* ===== Autoform: renderField with image/video & hidden support ===== */
  function renderField(path, schema, value, parent){
    const t=(schema && schema.type)|| (schema?.enum && 'string') || 'object';
    const ui=uiOf(schema);
    if (ui.hidden) return;

    const label=ui.label || schema.title || path.split('.').slice(-1)[0];
    const help=ui.help || schema.description || '';
    const placeholder=ui.placeholder || '';
    const widget=(ui.widget||'').toString().toLowerCase();
    const readOnly=!!schema.readOnly;

    const wrap=document.createElement('div'); wrap.className='mb-3 field';
    const lab=document.createElement('label'); lab.className='form-label'; lab.textContent=label;
    const hint=help ? `<div class="form-hint">${help}</div>` : '';

    const NAME=`af:${path}`;

    if(schema.enum && Array.isArray(schema.enum)){
      const sel=document.createElement('select'); sel.className='form-control z2h-dirty'; sel.name=NAME; if(readOnly) sel.disabled=true;
      schema.enum.forEach(v=>{
        const opt=document.createElement('option');
        opt.value=String(v); opt.textContent=String(v);
        if(String(v)===String(value ?? '')) opt.selected=true;
        sel.appendChild(opt);
      });
      wrap.appendChild(lab); wrap.appendChild(sel); wrap.insertAdjacentHTML('beforeend', hint); parent.appendChild(wrap); return;
    }

    if(t==='string' && (widget==='image' || widget==='video')){
      const row = document.createElement('div'); row.className='d-flex gap-2 align-items-center flex-wrap';
      const url = document.createElement('input');
      url.type='text'; url.className='form-control z2h-dirty'; url.name=NAME; url.placeholder=placeholder || (widget==='image'?'Upload or paste image URL':'Upload or paste video URL');
      if(value!=null) url.value=String(value);
      if(readOnly) url.readOnly=true;

      const fileInput = document.createElement('input');
      fileInput.type='file';
      fileInput.accept = widget==='image' ? 'image/*' : 'video/*';
      fileInput.className='d-none';
      const uploadBtn = document.createElement('button');
      uploadBtn.type='button';
      uploadBtn.className='btn btn-outline-secondary';
      uploadBtn.textContent = widget==='image' ? 'Upload image' : 'Upload media';
      if(readOnly){ uploadBtn.disabled=true; }
      uploadBtn.addEventListener('click', ()=> fileInput.click());
      fileInput.addEventListener('change', ()=>{
        const f = fileInput.files && fileInput.files[0];
        if(!f) return;
        const r=new FileReader();
        r.onload = ev=>{
          const res = ev.target?.result;
          if(typeof res === 'string'){
            url.value = res;
            url.dispatchEvent(new Event('input',{bubbles:true}));
          }
        };
        r.readAsDataURL(f);
      });

      wrap.appendChild(lab); row.appendChild(url); row.appendChild(uploadBtn); row.appendChild(fileInput); wrap.appendChild(row);

      if (ui.preview && url.value) {
        const prev = document.createElement(widget==='image'?'img':'video');
        if (widget==='video') prev.controls = true;
        prev.src = url.value; prev.className='mt-2 rounded'; prev.style.maxWidth='360px';
        wrap.appendChild(prev);
      }
      wrap.insertAdjacentHTML('beforeend', hint); parent.appendChild(wrap); return;
    }

    if(t==='string'){
      const isTextarea = !!ui.textarea;
      if(isTextarea){
        const ta=document.createElement('textarea'); ta.className='form-control z2h-dirty textarea-lg';
        ta.name=NAME; ta.placeholder=placeholder; if(value!=null) ta.value=String(value); if(readOnly) ta.readOnly=true;
        if(ui.rows){ ta.rows = parseInt(ui.rows,10) || 6; }
        wrap.appendChild(lab); wrap.appendChild(ta); wrap.insertAdjacentHTML('beforeend', hint); parent.appendChild(wrap); return;
      }
      const inp=document.createElement('input'); inp.type='text'; inp.className='form-control z2h-dirty'; inp.name=NAME; inp.placeholder=placeholder; if(value!=null) inp.value=String(value); if(readOnly) inp.readOnly=true;
      wrap.appendChild(lab); wrap.appendChild(inp); wrap.insertAdjacentHTML('beforeend', hint); parent.appendChild(wrap); return;
    }

    if(t==='number' || t==='integer'){
      const inp=document.createElement('input'); inp.type='number'; inp.step=(t==='integer'?'1':'any'); inp.className='form-control z2h-dirty'; inp.name=NAME; if(value!=null) inp.value=String(value); if(readOnly) inp.readOnly=true;
      wrap.appendChild(lab); wrap.appendChild(inp); wrap.insertAdjacentHTML('beforeend', hint); parent.appendChild(wrap); return;
    }

    if(t==='boolean'){
      const div=document.createElement('div'); div.className='form-check';
      const chk=document.createElement('input'); chk.type='checkbox'; chk.className='form-check-input z2h-dirty'; chk.name=NAME; chk.checked=!!value; if(readOnly) chk.disabled=true;
      const l2=document.createElement('label'); l2.className='form-check-label'; l2.textContent=label;
      div.appendChild(chk); div.appendChild(l2); parent.appendChild(div); return;
    }

    if(t==='array'){
      const box=document.createElement('div'); box.className='z2h-repeater';
      wrap.appendChild(lab);
      const list=document.createElement('div'); list.className='repeater-grid';
      const itemsSchema=schema.items||{};
      const itemUi = uiOf(itemsSchema);

      // Special case: featured projects picker (array of strings with widget=project-select)
      if(itemUi.widget === 'project-select'){
        const chips=document.createElement('div'); chips.className='d-flex flex-wrap gap-2 mb-2';
        const select=document.createElement('select'); select.className='form-select form-select-sm'; select.name=NAME + '::select';
        const btn=document.createElement('button'); btn.type='button'; btn.className='btn btn-soft-success btn-sm'; btn.textContent='Add project';

        const current = Array.isArray(value)? [...value] : [];
        const hiddenHost=document.createElement('div');
        const syncHidden=()=>{
          hiddenHost.innerHTML='';
          current.forEach((v,idx)=>{
            const h=document.createElement('input'); h.type='hidden'; h.name=`${NAME}[${idx}]`; h.value=v; hiddenHost.appendChild(h);
          });
        };
        const renderChips=()=>{
          chips.innerHTML='';
          current.forEach((slug,idx)=>{
            const chip=document.createElement('span'); chip.className='badge bg-secondary d-flex align-items-center gap-1';
            chip.textContent = slug;
            const x=document.createElement('button'); x.type='button'; x.className='btn-close btn-close-white btn-sm'; x.style.filter='invert(1)';
            x.addEventListener('click',()=>{ current.splice(idx,1); renderChips(); syncHidden(); setDirty(true); });
            chip.appendChild(x); chips.appendChild(chip);
          });
        };
        renderChips(); syncHidden();

        btn.addEventListener('click', ()=>{
          const selVal = select.value;
          if(selVal && !current.includes(selVal)){
            current.push(selVal);
            renderChips(); syncHidden(); setDirty(true);
          }
        });

        (async ()=>{
          try{
            const opts = await getProjectsOptions();
            select.innerHTML='';
            opts.forEach(o=>{
              const opt=document.createElement('option'); opt.value=o.value; opt.textContent=o.label; select.appendChild(opt);
            });
          }catch(_){}
        })();

        wrap.appendChild(chips);
        wrap.appendChild(select);
        wrap.appendChild(btn);
        wrap.appendChild(hiddenHost);
        wrap.insertAdjacentHTML('beforeend', hint);
        parent.appendChild(wrap);
        return;
      }

      // Default repeater with collapsible items
      (Array.isArray(value)?value:[]).forEach((v,idx)=>{
        const row=document.createElement('div'); row.className='repeater-item card p-3 mb-2';
        const hdr=document.createElement('div'); hdr.className='d-flex justify-content-between align-items-center mb-2';
        const title=document.createElement('div'); title.className='fw-semibold';
        title.textContent = (v && (v.title||v.name||v.label)) ? (v.title||v.name||v.label) : `${lab.textContent || 'Item'} ${idx+1}`;
        const toggle=document.createElement('button'); toggle.type='button'; toggle.className='btn btn-sm btn-outline'; toggle.textContent='Expand/Collapse';
        const body=document.createElement('div'); body.className='repeater-body d-none';
        toggle.addEventListener('click', ()=>{ body.classList.toggle('d-none'); });
        hdr.appendChild(title); hdr.appendChild(toggle); row.appendChild(hdr);
        renderField(`${path}[${idx}]`, itemsSchema, v, body);
        const rm=document.createElement('button'); rm.type='button'; rm.className='btn btn-soft-danger btn-sm mt-2'; rm.textContent='Remove';
        rm.addEventListener('click', ()=>{ row.remove(); setDirty(true); });
        body.appendChild(rm); row.appendChild(body); list.appendChild(row);
      });
      const add=document.createElement('button'); add.type='button'; add.className='btn btn-soft-success btn-sm mt-2'; add.textContent= (ui.addLabel||'Add');
      add.addEventListener('click', ()=>{
        const idx=list.querySelectorAll('.repeater-item').length;
        const row=document.createElement('div'); row.className='repeater-item card p-3 mb-2';
        const hdr=document.createElement('div'); hdr.className='d-flex justify-content-between align-items-center mb-2';
        const title=document.createElement('div'); title.className='fw-semibold'; title.textContent=`${lab.textContent||'Item'} ${idx+1}`;
        const toggle=document.createElement('button'); toggle.type='button'; toggle.className='btn btn-sm btn-outline'; toggle.textContent='Expand/Collapse';
        const body=document.createElement('div'); body.className='repeater-body d-none';
        toggle.addEventListener('click', ()=>{ body.classList.toggle('d-none'); });
        hdr.appendChild(title); hdr.appendChild(toggle); row.appendChild(hdr);
        renderField(`${path}[${idx}]`, itemsSchema, null, body);
        const rm=document.createElement('button'); rm.type='button'; rm.className='btn btn-soft-danger btn-sm mt-2'; rm.textContent='Remove';
        rm.addEventListener('click', ()=>{ row.remove(); setDirty(true); });
        body.appendChild(rm); row.appendChild(body); list.appendChild(row); setDirty(true);
      });
      wrap.appendChild(list); wrap.appendChild(add); wrap.insertAdjacentHTML('beforeend', hint); parent.appendChild(wrap); return;
    }

    const box=document.createElement('div'); box.className='card p-3';
    const props=schema.properties||{}; let keys=orderKeys(props, ui);
    if(keys.includes('left') && keys.includes('middle') && keys.includes('right')){
      keys = ['left','middle','right', ...keys.filter(k=>!['left','middle','right'].includes(k))];
    }
    wrap.appendChild(lab);
    keys.forEach(k=>{ renderField(`${path}.${k}`, props[k], (value||{})[k], box); });
    wrap.appendChild(box); wrap.insertAdjacentHTML('beforeend', hint); parent.appendChild(wrap);
  }

  function inferSchemaFromData(data){
    if(Array.isArray(data)){
      const first = data.find(v=>v!=null);
      if(first && typeof first === 'object' && !Array.isArray(first)){
        const props={};
        Object.keys(first).forEach(k=>{
          const v=first[k];
          props[k]={type:(typeof v==='number'?'number': typeof v==='boolean'?'boolean':'string'), 'x-ui':{label:k}};
        });
        return {type:'array', items:{type:'object', properties:props}};
      }
      return {type:'array', items:{type: typeof first==='number'?'number':'string'}};
    }
    if(data && typeof data==='object'){
      const props={};
      Object.keys(data).forEach(k=>{
        const v=data[k];
        if(v && typeof v==='object' && !Array.isArray(v)){
          props[k]={type:'object', properties: inferSchemaFromData(v).properties||{}};
        }else if(Array.isArray(v)){
          props[k]=inferSchemaFromData(v);
        }else{
          props[k]={type: typeof v==='number'?'number': typeof v==='boolean'?'boolean':'string'};
        }
        props[k]['x-ui']={label:k};
      });
      return {type:'object', properties:props};
    }
    return {type:'object', properties:{}};
  }

  function renderSectionAutoForm(panel, schemaUI, secData){
    const host=panel.querySelector('.z2h-autoform'); if(!host) return;
    host.innerHTML='';
    const panelKey=(panel.getAttribute('data-section-key')||'').trim();
    let sub=null;
    const isArrayData = Array.isArray(secData);
    if(panelKey && schemaUI?.properties && schemaUI.properties[panelKey]){
      sub = schemaUI.properties[panelKey];
      // If this node is an empty ref, fallback to variant pick
      if(!sub.properties && !sub.items){
        sub = pickSectionSubschema(schemaUI, secData);
      }
      // Explicit array handling when schema is present
      if((sub && (sub.type==='array' || sub.items)) && isArrayData){
        renderField(panelKey, sub, secData ?? [], host);
        const hint=panel.querySelector('[data-autoform-hint]'); if(hint) hint.style.display='';
        return;
      }
    }else{
      sub = pickSectionSubschema(schemaUI, secData);
    }
    if(!sub && secData!==undefined){
      sub = inferSchemaFromData(secData);
    }
    // If we still don't have items for an array data, synthesize a minimal array schema
    if(isArrayData && (!sub || (!sub.items && !sub.oneOf && !sub.anyOf))){
      sub = sub || {};
      sub.type = 'array';
      sub.items = sub.items || { type: 'object', properties: {} };
      const hint=panel.querySelector('[data-autoform-hint]'); if(hint) hint.style.display='';
      renderField(panelKey || 'section', sub, secData ?? [], host);
      return;
    }
    const props=sub && sub.properties ? sub.properties : {};
    const uiSub = uiOf(sub);
    const hint=panel.querySelector('[data-autoform-hint]'); if(hint) hint.style.display='';

    // If this node is an array (e.g., projects list), render directly
    if(sub && (sub.type==='array' || sub.items)){
      renderField(panelKey || 'section', sub, secData, host);
      return;
    }

    let keys=orderKeys(props, uiSub);
    if(panelKey==='approach'){
      const desired=['approachText','approachTop','approachMiddle','approachBottom','approachMotto'];
      keys = [...desired.filter(k=>keys.includes(k)), ...keys.filter(k=>!desired.includes(k))];
    } else if(keys.includes('left') && keys.includes('middle') && keys.includes('right')){
      keys = ['left','middle','right', ...keys.filter(k=>!['left','middle','right'].includes(k))];
    }
    if(!keys.length){ host.innerHTML='<div class="text-muted">No schema fields available.</div>'; return; }
    keys.forEach(k=>{
      if(k==='type' && (props[k]?.const || (Array.isArray(props[k]?.enum) && props[k].enum.length===1))) return;
      renderField(k, props[k], secData ? secData[k] : undefined, host);
    });
  }

  function serializeAutoForm(panel){
    const obj={};
    const type = panel.getAttribute('data-section-type') || '';
    if(type) obj.type = type;
    panel.querySelectorAll('[name^="af:"]').forEach(inp=>{
      const path=inp.name.slice(3);
      let v;
      if(inp.type==='checkbox') v=inp.checked;
      else if(inp.type==='number') v=(inp.value===''? null : (inp.step==='1'? parseInt(inp.value,10) : parseFloat(inp.value)));
      else v=inp.value;
      setDeep(obj, path.replace(/\./g,'.'), v);
    });
    return obj;
  }

  function isPlainObject(o){ return o && typeof o==='object' && !Array.isArray(o); }
  function clone(x){ return isPlainObject(x) ? Object.keys(x).reduce((a,k)=>{a[k]=clone(x[k]);return a;}, {}) : Array.isArray(x) ? x.map(clone) : x; }
  function deepMerge(base, patch){
    if(patch===undefined) return clone(base);
    if(!isPlainObject(base) || !isPlainObject(patch)) return patch;
    const out = clone(base);
    for(const k of Object.keys(patch)){
      const pv = patch[k];
      const bv = out[k];
      if(pv===undefined) continue;
      if(typeof pv==='string' && pv==='' && bv!==undefined) continue;
      if(Array.isArray(pv)){ out[k]=pv.map(clone); continue; }
      if(isPlainObject(pv)){ out[k]=deepMerge(isPlainObject(bv)?bv:{} , pv); continue; }
      out[k]=pv;
    }
    return out;
  }
  function isEmptySection(sec){
    if(!sec) return true;
    if(typeof sec.type === 'string' && sec.type.trim() !== '') return false;
    const keys = Object.keys(sec);
    if(keys.length === 0) return true;
    if(keys.length === 1 && keys[0] === 'data' && isPlainObject(sec.data) && Object.keys(sec.data).length===0) return true;
    return false;
  }

  function serialize(){
    const out={
      replace: false, /* standard value (toggle removed) */
      seo: {
        title: document.getElementById('f-seo-title')?.value || '',
        description: document.getElementById('f-seo-desc')?.value || ''
      }
    };

    const sectionPanels = Array.from(document.querySelectorAll('[data-section-index]'));
    const acc = [];
    const keyed = {};
    const schemaUI = window.SCHEMA_UI || {};

    sectionPanels.forEach(panel=>{
      let prev = {};
      const seedEl = panel.querySelector('.z2h-sec-json');
      if(seedEl){ try{ prev = JSON.parse(seedEl.textContent||'{}')||{}; }catch{} }

      const hasAuto = panel.querySelector('[name^="af:"]')!=null;
      let patch = hasAuto ? serializeAutoForm(panel) : {};

      if(!hasAuto){
        panel.querySelectorAll('[data-k]').forEach(el=>{
          const k=el.getAttribute('data-k'); let v=el.value;
          if(k==='schema_version') v=Number(v||1);
          if(k){ if(k.includes('[')) setDeep(patch,k,v); else patch[k]=v; }
        });
        ['media','actions'].forEach(rep=>{
          const host=panel.querySelector(`.z2h-repeater[data-repeater="${rep}"]`);
          if(host){
            const arr=[]; host.querySelectorAll('.z2h-rep-item, .repeater-item').forEach(item=>arr.push(getRepItemObject(item)));
            patch[rep]=arr;
          }
        });
        const jsonArea=panel.querySelector('.z2h-json-editor');
        if(jsonArea){
          const txt=jsonArea.value.trim();
          if(txt){
            try{
              const parsed=JSON.parse(txt);
              if(isPlainObject(parsed)) patch['data']=parsed;
              jsonArea.classList.remove('is-invalid');
            }catch(e){
              jsonArea.classList.add('is-invalid'); throw new Error('Invalid JSON in Advanced Data');
            }
          }
        }
      }

      let merged = deepMerge(prev, patch);
      const panelType = panel.getAttribute('data-section-type') || '';
      if((!merged.type || String(merged.type).trim()==='') && panelType){ merged.type = panelType; }

      if(!isEmptySection(merged)){
        const key = (panel.getAttribute('data-section-key')||'').trim();
        if(key){
          if(Object.keys(merged).length === 1 && merged[key] !== undefined){
            keyed[key] = merged[key];
          }else{
            keyed[key] = merged;
          }
        }else{
          acc.push(merged);
        }
      }
      if(seedEl){ try{ seedEl.textContent = JSON.stringify(merged); }catch{} }
    });

    if(acc.length){
      out.sections = acc;
    }
    if(Object.keys(keyed).length){
      Object.assign(out, keyed);
    }

    // Always pull fresh Projects data from the projects panel to avoid accidental wipes
    const projPanel = document.querySelector('[data-section-key="projects"]');
    if(projPanel){
      try{
        const projPatch = serializeAutoForm(projPanel) || {};
        if(Array.isArray(projPatch)){
          out.projects = projPatch;
        }else if(Array.isArray(projPatch.projects)){
          out.projects = projPatch.projects;
        }else if(projPatch.projects && Array.isArray(projPatch.projects.projects)){
          out.projects = projPatch.projects.projects;
        }
      }catch(_){}
      if(!out.projects){
        const seed = projPanel.querySelector('.z2h-sec-json');
        if(seed){
          try{
            const seedObj = JSON.parse(seed.textContent || '{}');
            if(Array.isArray(seedObj)) out.projects = seedObj;
            else if(seedObj && Array.isArray(seedObj.projects)) out.projects = seedObj.projects;
          }catch(_){}
        }
      }
    }

    contentJson.value = JSON.stringify(out);
    return out;
  }

  let t;
  function onDirty(){ setDirty(true); clearTimeout(t); t=setTimeout(()=>{ const obj=serialize(); try{ localStorage.setItem('z2h-edit-backup-'+entryId, JSON.stringify(obj)); }catch{} }, 250); }
  document.addEventListener('input', (e)=>{ if(e.target.closest('.z2h-dirty')|| e.target.name?.startsWith('af:')) onDirty(); });
  document.addEventListener('change', (e)=>{ if(e.target.closest('.z2h-dirty')|| e.target.name?.startsWith('af:')) onDirty(); });

  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); document.getElementById('z2h-edit-form').requestSubmit(); }
    if(e.key.toLowerCase()==='f'){ const s=document.getElementById('z2h-section-search'); s?.focus(); e.preventDefault(); }
  });

  form.addEventListener('submit', function(ev){
    try{ serialize(); }
    catch(err){ ev.preventDefault(); flashErr(err.message||'Invalid data'); return; }
    try{ localStorage.removeItem('z2h-edit-backup-'+entryId); }catch{}
    setDirty(false);
    setTimeout(()=>flashOk('Saved.'), 10);
  });

  // Projects-local draft (button inside panel)
  document.querySelectorAll('[data-projects-draft-btn]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      const panel = btn.closest('[data-section-key="projects"]');
      if(!panel){ flashErr('Projects panel not found'); return; }
      try{
        const projPatch = serializeAutoForm(panel) || {};
        const stash = Array.isArray(projPatch) ? {projects: projPatch} : {projects: projPatch.projects || []};
        localStorage.setItem('z2h-projects-draft-'+entryId, JSON.stringify(stash));
        flashOk('Projects draft saved locally.');
      }catch(err){
        flashErr(err?.message||'Could not save draft');
      }
    });
  });

  async function fetchDeliveryJSON(){
    const tenant=root?.dataset?.tenant||'';
    const section=root?.dataset?.sectionKey||'';
    const slug=root?.dataset?.entrySlug||'';
    if(!tenant||!section||!slug) throw new Error('Missing tenant/section/slug');

    const url = `/delivery/v1/tenants/${tenant}/sections/${encodeURIComponent(section)}/entries/${encodeURIComponent(slug)}?_=${Date.now()}`;
    const res = await fetch(url, { headers:{'X-Requested-With':'fetch'} });
    if(!res.ok){
      let txt=''; try{ txt=await res.text(); }catch(_){}
      throw new Error(txt || 'Delivery fetch failed');
    }
    return res.json();
  }

  function fillLegacyInputsFromSection(panel, sec){
    const map = {
      'type':'type','schema_version':'schema_version','eyebrow':'eyebrow',
      'heading':'heading','subheading':'subheading','richText':'richText'
    };
    Object.entries(map).forEach(([k, dk])=>{
      const el = panel.querySelector(`[data-k="${dk}"]`);
      if(!el) return;
      if(dk==='schema_version'){ el.value = (sec.schema_version ?? sec.schemaVersion ?? el.value ?? 1); }
      else{ el.value = (sec[k] ?? sec[dk] ?? ''); }
    });

    const mediaHost = panel.querySelector('.z2h-repeater[data-repeater="media"]');
    if(mediaHost){
      mediaHost.innerHTML='';
      const mediaArr = Array.isArray(sec.media)? sec.media : [];
      mediaArr.forEach(m=>{
        const node = document.createElement('div');
        node.className='z2h-rep-item card p-3 mb-2';
        node.innerHTML = `
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label small">Type</label>
              <select class="form-control z2h-dirty" data-k="type">
                <option value="image"${(m.type||'image')==='image'?' selected':''}>image</option>
                <option value="video"${(m.type||'image')==='video'?' selected':''}>video</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label small">URL</label>
              <input type="text" class="form-control z2h-dirty" data-k="url" value="${m.url||''}" placeholder="https://...">
            </div>
            <div class="col-md-3">
              <label class="form-label small">Alt</label>
              <input type="text" class="form-control z2h-dirty" data-k="alt" value="${m.alt||''}">
            </div>
          </div>
          <div class="text-end mt-2"><button type="button" class="btn btn-sm btn-soft-danger z2h-remove">Remove</button></div>
        `;
        mediaHost.appendChild(node);
      });
    }

    const actionsHost = panel.querySelector('.z2h-repeater[data-repeater="actions"]');
    if(actionsHost){
      actionsHost.innerHTML='';
      const actionsArr = Array.isArray(sec.actions)? sec.actions : [];
      actionsArr.forEach(b=>{
        const node = document.createElement('div');
        node.className='z2h-rep-item card p-3 mb-2';
        node.innerHTML = `
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label small">Label</label>
              <input type="text" class="form-control z2h-dirty" data-k="label" value="${b.label||''}">
            </div>
            <div class="col-md-8">
              <label class="form-label small">Href</label>
              <input type="text" class="form-control z2h-dirty" data-k="href" value="${b.href||''}">
            </div>
          </div>
          <div class="text-end mt-2"><button type="button" class="btn btn-sm btn-soft-danger z2h-remove">Remove</button></div>
        `;
        actionsHost.appendChild(node);
      });
    }

    const jsonArea=panel.querySelector('.z2h-json-editor');
    if(jsonArea){
      try{ jsonArea.value = JSON.stringify(sec.data ?? {}, null, 2); jsonArea.classList.remove('is-invalid'); }
      catch(_){ jsonArea.value = "{}"; }
    }

    const seed = panel.querySelector('.z2h-sec-json');
    if(seed){ try{ seed.textContent = JSON.stringify(sec || {}); }catch(_){ } }
  }

  async function restoreFromDelivery(){
    const btn = document.getElementById('z2h-restore-btn');
    if(!btn) return;
    btn.disabled = true; const old = btn.textContent; btn.textContent = 'Recovering...';
    try{
      const payload = await fetchDeliveryJSON();
      const sections = payload?.data?.sections || payload?.sections || [];
      if(!Array.isArray(sections) || sections.length===0){ flashErr('No sections found in Delivery payload.'); return; }

      const sectionPanels = Array.from(document.querySelectorAll('[data-section-index]'));
      const n = Math.min(sections.length, sectionPanels.length);
      for(let i=0;i<n;i++){
        const panel = sectionPanels[i];
        const sec   = sections[i] || {};
        if(!sec.type){
          const panelType = panel.getAttribute('data-section-type') || '';
          if(panelType) sec.type = panelType;
        }
        fillLegacyInputsFromSection(panel, sec);
      }

      const schema= await maybeFetchSchemaUI() || SCHEMA_UI;
      if(schema){
        sectionPanels.forEach((panel)=>{
          let secDataLegacy = {};
          const seed = panel.querySelector('.z2h-sec-json');
          if (seed) { try { secDataLegacy = JSON.parse(seed.textContent || '{}') || {}; } catch(_) {} }
          panel.querySelectorAll('[data-k]').forEach(el=>{
            const k=el.getAttribute('data-k'); if(!k) return;
            let v=el.value;
            if(k==='schema_version') v=Number(v||1);
            if (secDataLegacy[k] === undefined) secDataLegacy[k]=v;
          });
          const jsonArea=panel.querySelector('.z2h-json-editor');
          if(jsonArea){
            try{
              const parsed=JSON.parse(jsonArea.value||'{}');
              if(parsed && typeof parsed==='object' && secDataLegacy.data === undefined) secDataLegacy.data=parsed;
            }catch(_){}
          }
          renderSectionAutoForm(panel, schema, secDataLegacy);
        });
      }

      setDirty(true);
      serialize();
      flashOk('Recovered from Delivery. Review and Save/Publish.');
    }catch(err){
      flashErr(err?.message||'Recover failed');
    }finally{
      btn.textContent = old; btn.disabled = false;
    }
  }
  restoreBtn?.addEventListener('click', restoreFromDelivery);

  (async function initAutoForms(){
    const schema = await maybeFetchSchemaUI() || SCHEMA_UI;
    if(!schema) return;
    const sectionPanels = Array.from(document.querySelectorAll('[data-section-index]'));
    sectionPanels.forEach((panel)=>{
      let secDataLegacy = {};
      const seed = panel.querySelector('.z2h-sec-json');
      if (seed) { try { secDataLegacy = JSON.parse(seed.textContent || '{}') || {}; } catch(_) {} }
      panel.querySelectorAll('[data-k]').forEach(el=>{
        const k=el.getAttribute('data-k'); if(!k) return;
        let v=el.value;
        if(k==='schema_version') v=Number(v||1);
        if (secDataLegacy[k] === undefined) secDataLegacy[k]=v;
      });
      const jsonArea=panel.querySelector('.z2h-json-editor');
      if(jsonArea){
        try{
          const parsed=JSON.parse(jsonArea.value||'{}');
          if(parsed && typeof parsed==='object' && secDataLegacy.data === undefined) secDataLegacy.data=parsed;
        }catch(_){}
      }

      // Restore local projects draft if present and current data is empty
      const isProjects = (panel.getAttribute('data-section-key')||'') === 'projects';
      if(isProjects){
        const hasProjects = Array.isArray(secDataLegacy) ? secDataLegacy.length>0 : Array.isArray(secDataLegacy.projects) ? secDataLegacy.projects.length>0 : false;
        if(!hasProjects){
          try{
            const draft = localStorage.getItem('z2h-projects-draft-'+entryId);
            if(draft){
              const parsed = JSON.parse(draft);
              if(Array.isArray(parsed?.projects)) secDataLegacy = { projects: parsed.projects };
            }
          }catch(_){}
        }
      }
      renderSectionAutoForm(panel, schema, secDataLegacy);
    });
  })();

  /* Back to Top show/hide + smooth scroll */
  (function(){
    const btn = document.getElementById('z2h-back-top');
    if(!btn) return;
    const showAt = 600;
    function onScroll(){
      if(window.scrollY > showAt) btn.classList.add('show');
      else btn.classList.remove('show');
    }
    window.addEventListener('scroll', onScroll, { passive:true });
    onScroll();
    btn.addEventListener('click', ()=>window.scrollTo({top:0, behavior:'smooth'}));
  })();

  try{
    if (typeof serialize === 'function') { serialize(); }
    if (typeof setDirty === 'function') { setDirty(false); }
  }catch(e){ console.error('Init error:', e); }
})();
</script>
{% endblock %}


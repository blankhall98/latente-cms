{% extends "base.html" %}
{% block title %}Edit Page · {{ page.title }} · Latente CMS{% endblock %}

{% block content %}
<section class="container my-4"
         id="z2h-edit-root"
         data-tenant="{{ active_tenant.slug if active_tenant else '' }}"
         data-tenant-id="{{ active_tenant.id if active_tenant else '' }}"
         data-user-id="{{ user.id if user else '' }}"
         data-section-key="{{ page.section_key if page.section_key else '' }}"
         data-entry-id="{{ page.id }}"
         data-entry-slug="{{ page.slug }}">

  <!-- Toolbar (sticky) -->
  <header id="z2h-toolbar" class="z2h-toolbar mb-3" aria-label="Page header actions">
    <div>
      <h1 class="h4 m-0 text-capitalize">{{ page.title }}</h1>
      <div class="z2h-meta row gx-2 gy-1 mt-1">
        <div class="col-auto"><code class="z2h-chip code">/{{ page.slug }}</code></div>
        <div class="col-auto"><span class="z2h-chip">Section: <strong>{{ page.section_name }}</strong></span></div>
        {% set s=(page.status or '').lower() %}
        <div class="col-auto">
          <span id="z2h-status-chip" class="z2h-chip z2h-chip-status {{ s }}">{{ s }}</span>
        </div>
        <div class="col-auto"><span class="z2h-chip">Schema v{{ page.schema_version }}</span></div>
        <div class="col-auto d-none d-sm-inline"><span class="z2h-dot"></span><span class="z2h-save-txt">Saved</span></div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline d-none d-md-inline" id="z2h-delivery-btn" target="_blank" rel="noopener">Delivery JSON</a>
      <button type="button" class="btn btn-outline d-none d-md-inline" id="z2h-publish-btn" disabled title="Save changes first">Publish</button>
      <a class="btn btn-outline" href="/admin/pages">Cancel</a>
      <button form="z2h-edit-form" class="btn btn-cta" type="submit" id="z2h-save-btn">Save</button>
    </div>
  </header>

  <!-- Toasts (flash) – fixed corner, always above sticky UI -->
  <div class="toast-container position-fixed top-0 end-0 p-3" id="z2h-toast-host" style="z-index:2000;">
    {% if error %}
    <div class="toast align-items-center text-bg-danger border-0" role="status" data-bs-delay="5500">
      <div class="d-flex">
        <div class="toast-body">{{ error }}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
    {% endif %}
    {% if ok_message %}
    <div class="toast align-items-center text-bg-success border-0" role="status" data-bs-delay="3800">
      <div class="d-flex">
        <div class="toast-body">{{ ok_message }}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Layout -->
  <form id="z2h-edit-form" class="z2h-editor-grid-simple" method="post" action="">
    <!-- Sidebar -->
    <aside class="z2h-editor-sidebar">
      <div class="card p-3 mb-2">
        <label class="form-label small mb-1">Find section</label>
        <input type="search" id="z2h-section-search" class="form-control form-control-sm" placeholder="Type to filter…">
      </div>

      <nav class="card p-2 z2h-side-list" id="z2h-side-nav" aria-label="Section navigator">
        <button type="button" class="z2h-side-item active" data-panel-id="panel-general">
          <span class="z2h-side-label">General</span><span class="chip chip-type">SEO</span>
        </button>
        {% if sections_ui and sections_ui|length > 0 %}
          {% for it in sections_ui %}
            {% set _type = (it.get('sec') or {}).get('type', 'Block') %}
            <button type="button" class="z2h-side-item" data-panel-id="panel-section-{{ it.index }}">
              <span class="z2h-side-label">{{ it.label }}</span>
              <span class="chip chip-type">{{ _type }}</span>
            </button>
          {% endfor %}
        {% else %}
          <div class="z2h-side-empty">No sections yet</div>
        {% endif %}
      </nav>
      
    </aside>

    <!-- Main -->
    <main class="z2h-editor-main">
      <div id="z2h-panels" class="z2h-panels">

        <!-- General -->
        <section id="panel-general" class="z2h-panel" tabindex="-1">
          <div class="z2h-panel-head">
            <h2 class="z2h-panel-title">General</h2>
            <span class="z2h-panel-sub">Page meta</span>
          </div>

          <div class="card p-3 mb-3">
            <div class="form-check">
              <input class="form-check-input z2h-dirty" type="checkbox" id="f-replace" {% if replace_val %}checked{% endif %}>
              <label for="f-replace" class="form-check-label">Replace (advanced publishing flag)</label>
            </div>
          </div>

          <div class="card p-3">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">SEO Title <span class="text-muted small">(≤70)</span></label>
                <input type="text" id="f-seo-title" class="form-control z2h-dirty z2h-count" maxlength="120"
                       value="{{ seo_title|default('') }}" placeholder="Up to ~70 chars" data-max="70">
                <div class="form-hint"><span data-for="f-seo-title">0</span>/70</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">SEO Description <span class="text-muted small">(≤160)</span></label>
                <input type="text" id="f-seo-desc" class="form-control z2h-dirty z2h-count" maxlength="240"
                       value="{{ seo_desc|default('') }}" placeholder="Up to ~160 chars" data-max="160">
                <div class="form-hint"><span data-for="f-seo-desc">0</span>/160</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Sections -->
        {% for it in sections_ui %}
        {% set S = it.get('sec') or {} %}
        <section id="panel-section-{{ it.index }}"
                 class="z2h-panel d-none"
                 data-section-index="{{ it.index }}"
                 tabindex="-1">

          <div class="z2h-panel-head">
            <h2 class="z2h-panel-title">{{ it.label }}</h2>
            <span class="z2h-panel-sub">Block editor</span>
          </div>

          <!-- Base -->
          <div class="card p-3 mb-3">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Type</label>
                <input type="text" class="form-control" data-k="type" value="{{ S.type or '' }}" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">Schema Version</label>
                <input type="number" class="form-control z2h-dirty" data-k="schema_version" value="{{ S.schema_version or 1 }}" min="1">
              </div>
              <div class="col-md-4">
                <label class="form-label">Eyebrow</label>
                <input type="text" class="form-control z2h-dirty" data-k="eyebrow" value="{{ S.eyebrow or '' }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Heading</label>
                <input type="text" class="form-control z2h-dirty" data-k="heading" value="{{ S.heading or '' }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Subheading</label>
                <input type="text" class="form-control z2h-dirty" data-k="subheading" value="{{ S.subheading or '' }}">
              </div>
              <div class="col-12">
                <label class="form-label">Rich Text</label>
                <textarea rows="5" class="form-control z2h-dirty" data-k="richText" placeholder="Markdown/HTML later">{{ S.richText or '' }}</textarea>
              </div>
            </div>
          </div>

          <!-- Media -->
          <div class="card p-3 mb-3">
            <div class="d-flex align-items-center justify-content-between mb-1">
              <h3 class="h6 m-0">Media</h3>
              <button type="button" class="btn btn-outline btn-sm z2h-add" data-repeater="media">Add media</button>
            </div>
            <div class="z2h-repeater mt-2" data-repeater="media">
              {% for m in (S.media or []) %}
              <div class="z2h-rep-item card p-2 mb-2">
                <div class="row g-2 align-items-end">
                  <div class="col-3">
                    <label class="form-label small">Type</label>
                    <select class="form-control z2h-dirty" data-k="type">
                      {% set _t = m.type or 'image' %}
                      <option value="image" {{ 'selected' if _t=='image' else '' }}>image</option>
                      <option value="video" {{ 'selected' if _t=='video' else '' }}>video</option>
                    </select>
                  </div>
                  <div class="col-6">
                    <label class="form-label small">URL</label>
                    <input type="text" class="form-control z2h-dirty" data-k="url" value="{{ m.url or '' }}" placeholder="https://...">
                  </div>
                  <div class="col-3">
                    <label class="form-label small">Alt</label>
                    <input type="text" class="form-control z2h-dirty" data-k="alt" value="{{ m.alt or '' }}">
                  </div>
                </div>
                <div class="text-end mt-2"><button type="button" class="btn btn-sm btn-outline-danger z2h-remove">Remove</button></div>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Actions -->
          <div class="card p-3 mb-3">
            <div class="d-flex align-items-center justify-content-between mb-1">
              <h3 class="h6 m-0">Actions</h3>
              <button type="button" class="btn btn-outline btn-sm z2h-add" data-repeater="actions">Add action</button>
            </div>
            <div class="z2h-repeater mt-2" data-repeater="actions">
              {% for b in (S.actions or []) %}
              <div class="z2h-rep-item card p-2 mb-2">
                <div class="row g-2 align-items-end">
                  <div class="col-md-4">
                    <label class="form-label small">Label</label>
                    <input type="text" class="form-control z2h-dirty" data-k="label" value="{{ b.label or '' }}">
                  </div>
                  <div class="col-md-8">
                    <label class="form-label small">Href</label>
                    <input type="text" class="form-control z2h-dirty" data-k="href" value="{{ b.href or '' }}">
                  </div>
                </div>
                <div class="text-end mt-2"><button type="button" class="btn btn-sm btn-outline-danger z2h-remove">Remove</button></div>
              </div>
              {% endfor %}
            </div>
          </div>

          <!-- Advanced Data (JSON) -->
          <div class="card p-3 mb-1">
            <div class="d-flex align-items-center justify-content-between">
              <h3 class="h6 m-0">Advanced Data (JSON)</h3>
              <small class="text-muted">Edits <code>section.data</code></small>
            </div>
            <textarea class="form-control z2h-dirty z2h-json-editor" rows="8"
                      data-data-json="true">{{ (S.data | tojson(indent=2)) if S.data else "{}" }}</textarea>
            <div class="form-hint">Must be valid JSON.</div>
          </div>
        </section>
        {% endfor %}

        <!-- Hidden JSON -->
        <textarea name="content_json" id="z2h-content-json" class="d-none"></textarea>

        <!-- Bottom actions (mobile only) -->
        <div class="z2h-bottom-actions d-md-none">
          <a class="btn btn-outline me-auto" href="/admin/pages">Cancel</a>
          <button class="btn btn-cta" type="submit">Save</button>
        </div>
      </div>
    </main>
  </form>
</section>

<!-- Modal Publish -->
<div class="modal fade" id="z2hPublishModal" tabindex="-1" aria-labelledby="z2hPublishLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="z2hPublishLabel">Publish this page?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        The page will be published to the public Delivery API. Continue?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-cta" id="z2h-confirm-publish">Publish</button>
      </div>
    </div>
  </div>
</div>

<style>
  :root{ --nav-h:56px; }

  /* Toolbar (sticky + seamless merge with navbar when stuck) */
  .z2h-toolbar{
    position: sticky;
    top: var(--nav-h);
    z-index: 1020; /* below modal backdrop (1040) and modal (1050) */
    display:flex; align-items:center; justify-content:space-between; gap:1rem;
    padding:.75rem 1rem; border:1px solid var(--border); border-radius:12px;
    background:#fff; box-shadow: var(--shadow-sm);
    transition: margin .55s ease-in-out, padding .55s ease-in-out,
                border-radius .45s ease-in-out, box-shadow .45s ease-in-out;
  }
  .z2h-toolbar.is-stuck{
    border-top: 0;            /* remove top border so it fuses with navbar bottom border */
    margin-top: -1px;         /* overlap the navbar border by 1px: no seam */
    border-radius:0 0 0 0;
    padding:.85rem 0;
    border-left:0; border-right:0;
    box-shadow: 0 6px 22px rgba(16,24,40,.12);
    margin-left: calc(50% - 50vw);
    margin-right: calc(50% - 50vw);
    padding-left: calc((100vw - 100%) / 2);
    padding-right: calc((100vw - 100%) / 2);
  }

  /* Chips */
  .z2h-chip{ display:inline-flex; align-items:center; gap:.25rem; padding:.18rem .5rem; border-radius:999px;
             background:#faf8f5; border:1px solid var(--border); color:var(--text-2); font-size:.78rem; }
  .z2h-chip.code{ background:#f6f8ff; border-color:#e3e8ff; color:#334; }
  .z2h-chip-status{ text-transform:uppercase; letter-spacing:.08em; font-weight:700; }
  .z2h-chip-status.published{ background:#eefaf3; border-color:#d6f4e2; color:#175e37; }
  .z2h-chip-status.draft{ background:#fff8ea; border-color:#ffe5b3; color:#7a520c; }
  .z2h-chip-status.archived{ background:#f4f6f8; border-color:#e5e7eb; color:#3b4450; }
  .z2h-dot{ width:.55rem; height:.55rem; border-radius:999px; background:#16a34a; display:inline-block; margin-right:.25rem; }

  /* Grid */
  .z2h-editor-grid-simple{ display:grid; grid-template-columns: 300px minmax(0,1fr); gap:16px; }
  @media (max-width: 991.98px){ .z2h-editor-grid-simple{ grid-template-columns: 1fr; } }

  /* Sidebar pinned below toolbar (below modal too) */
  .z2h-editor-sidebar{ position:sticky; top: calc(var(--nav-h) + 16px); align-self:start; z-index: 1010; }

  /* Side list */
  .z2h-side-list{ border:1px solid var(--border); }
  .z2h-side-item{
    display:grid; grid-template-columns: 1fr auto; align-items:center;
    gap:.5rem; padding:.58rem .7rem; border:0; width:100%; background:transparent;
    text-align:left; border-radius:8px; margin:.12rem 0; cursor:pointer; color:var(--text-2);
    transition: background-color .25s ease, color .25s ease;
  }
  .z2h-side-item.active{ background:var(--surface-2); color:var(--text-1); font-weight:700; }
  .z2h-side-item:hover{ background:#f8f7f4; color:var(--text-1); }
  .chip{ font-size:.72rem; border-radius:999px; padding:.05rem .55rem; border:1px solid var(--border); background:#fff; color:#2f5fa8; }
  .chip-type{ min-width:88px; text-align:center; }
  .z2h-tips{ color:#344256; }

  /* Panels */
  .z2h-panel{ animation:z2hFade .12s ease-in; outline:none; }
  .z2h-panel-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:.75rem; }
  .z2h-panel-title{ font-size:.95rem; text-transform:uppercase; letter-spacing:.12em; font-weight:800; margin:0; }
  .z2h-panel-sub{ color:var(--text-2); font-size:.85rem; }
  @keyframes z2hFade { from{opacity:.6; transform:translateY(2px);} to{opacity:1; transform:none;} }

  .form-control{ border-radius:10px; }
  .form-hint{ font-size:.78rem; color:var(--text-2); margin-top:.2rem; }

  .z2h-rep-item{ border:1px dashed var(--border); }

  .z2h-bottom-actions{
    position:sticky; bottom:0; padding:.75rem; display:flex; gap:.5rem; justify-content:end;
    background:transparent; border:0;
  }

  .is-invalid{ border-color:#ef4444 !important; box-shadow:0 0 0 .18rem rgba(239,68,68,.16) !important; }
</style>

<script>
(function(){
  // ---- Ensure we start at the very top once (fix #1) ----
  try{
    if (!sessionStorage.getItem('z2h_edit_scrolled_once')) {
      window.scrollTo({top:0, left:0, behavior:'auto'});
      sessionStorage.setItem('z2h_edit_scrolled_once','1');
    }
  }catch(_){}

  // ---- Compute navbar offset ----
  function updateOffsets(){
    const nav = document.querySelector('.navbar, header nav, .z2h-navbar');
    const navH = nav ? nav.offsetHeight : 56;
    document.documentElement.style.setProperty('--nav-h', `${navH}px`);
  }
  updateOffsets();
  window.addEventListener('resize', updateOffsets);

  // ---- Flash toasts (fix #4) ----
  const host = document.getElementById('z2h-toast-host');
  if (host){
    host.querySelectorAll('.toast').forEach(t => {
      try { new bootstrap.Toast(t).show(); } catch(_) {}
    });
  }

  // ---- Sticky toolbar toggle (fix #2: merge with navbar) ----
  const toolbar = document.getElementById('z2h-toolbar');
  if (toolbar){
    let stuck=false;
    const onScroll=()=>{ const add = window.scrollY>12; if(add!==stuck){ toolbar.classList.toggle('is-stuck', add); stuck=add; } };
    onScroll(); window.addEventListener('scroll', onScroll, {passive:true});
  }

  // ---- Editor logic (unchanged) ----
  const root   = document.getElementById('z2h-edit-root');
  const nav    = document.getElementById('z2h-side-nav');
  const panels = document.querySelectorAll('.z2h-panel');
  const form   = document.getElementById('z2h-edit-form');
  const contentJson = document.getElementById('z2h-content-json');
  const entryId = root?.dataset?.entryId;

  let isDirty = false;
  const statusDot = document.querySelector('.z2h-dot');
  const saverTxt  = document.querySelector('.z2h-save-txt');
  const publishBtn = document.getElementById('z2h-publish-btn');

  function setDirty(v){
    isDirty = !!v;
    if (statusDot) statusDot.style.background = v ? '#f59e0b' : '#16a34a';
    if (saverTxt)  saverTxt.textContent = v ? 'Unsaved' : 'Saved';
    if (publishBtn){
      publishBtn.disabled = v;
      publishBtn.title = v ? 'Save changes first' : 'Publish';
    }
  }

  // Scroll helper (skip on first render to avoid jumping; fix #1)
  let firstRender = true;
  function showPanel(id, opts){ // opts={silent:true}
    panels.forEach(p=>p.classList.add('d-none'));
    const el = document.getElementById(id);
    if (el){ el.classList.remove('d-none'); el.focus(); }
    nav.querySelectorAll('.z2h-side-item').forEach(it=>{
      it.classList.toggle('active', it.getAttribute('data-panel-id')===id);
    });
    if (opts && opts.silent) return;
    const navH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--nav-h')) || 56;
    const y = form.getBoundingClientRect().top + window.scrollY - navH - 8;
    window.scrollTo({ top: y, behavior: 'smooth' });
  }

  // Initial panel (silent to prevent initial jump)
  showPanel('panel-general', {silent:true});

  // Side-menu click
  nav.addEventListener('click', (e)=>{
    const btn = e.target.closest('.z2h-side-item'); if(!btn) return;
    const pid = btn.getAttribute('data-panel-id'); if(pid) showPanel(pid);
  });

  // Filter
  const finder  = document.getElementById('z2h-section-search');
  function filterNav(){
    const q=(finder.value||'').toLowerCase();
    nav.querySelectorAll('.z2h-side-item').forEach(it=>{
      if(it.dataset.panelId==='panel-general'){ it.classList.remove('d-none'); return; }
      const txt = it.textContent.toLowerCase();
      it.classList.toggle('d-none', !txt.includes(q));
    });
  }
  finder.addEventListener('input', filterNav);
  window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='f'){ finder.focus(); e.preventDefault(); } });

  // Repeaters
  function setDeep(obj, path, value){
    const parts = path.replace(/\]/g,'').split('.');
    let cur=obj;
    for(let i=0;i<parts.length;i++){
      const p=parts[i];
      if(p.includes('[')){
        const name=p.split('[')[0];
        const idx=(p.match(/\[(\d+)\]$/)||[])[1];
        if(!cur[name]) cur[name]=[];
        if(idx!==undefined){
          const n=parseInt(idx,10); if(!cur[name][n]) cur[name][n]={};
          if(i===parts.length-1) cur[name][n]=value; else cur=cur[name][n];
        }else{
          if(i===parts.length-1) cur[name].push(value); else cur=cur[name];
        }
      }else{
        if(i===parts.length-1){ cur[p]=value; }
        else{ if(!cur[p]||typeof cur[p]!=='object') cur[p]={}; cur=cur[p]; }
      }
    }
  }
  function getRepItemObject(repItem){
    const obj={};
    repItem.querySelectorAll('[data-k]').forEach(el=>{
      const k=el.getAttribute('data-k'); let v=el.value;
      if(k && k.endsWith(']')) setDeep(obj,k,v); else if(k) obj[k]=v;
    });
    return obj;
  }
  function mkRepItem(repeater){
    const last = repeater.querySelector('.z2h-rep-item:last-of-type'); let node;
    if(last){ node = last.cloneNode(true); node.querySelectorAll('input,textarea,select').forEach(el=>el.value=''); }
    else{
      node=document.createElement('div'); node.className='z2h-rep-item card p-2 mb-2';
      node.innerHTML=`<div class="row g-2">
        <div class="col"><input type="text" class="form-control z2h-dirty" data-k="label" placeholder="Label"></div>
        <div class="col"><input type="text" class="form-control z2h-dirty" data-k="href" placeholder="Href"></div>
      </div><div class="text-end mt-2"><button type="button" class="btn btn-sm btn-outline-danger z2h-remove">Remove</button></div>`;
    }
    node.querySelectorAll('input,textarea,select').forEach(x=>x.classList.add('z2h-dirty'));
    return node;
  }
  document.addEventListener('click', (e)=>{
    const addBtn = e.target.closest('.z2h-add');
    if(addBtn){
      const name=addBtn.getAttribute('data-repeater');
      const host=addBtn.closest('section').querySelector(`.z2h-repeater[data-repeater="${name}"]`);
      if(host){ host.appendChild(mkRepItem(host)); setDirty(true); }
    }
    const rmBtn = e.target.closest('.z2h-remove');
    if(rmBtn){ const item=rmBtn.closest('.z2h-rep-item'); if(item){ item.remove(); setDirty(true); } }
  });

  // Counters
  document.querySelectorAll('.z2h-count').forEach(inp=>{
    const max=Number(inp.dataset.max||"0"); const meter=document.querySelector(`[data-for="${inp.id}"]`);
    function upd(){ const n=(inp.value||'').trim().length; if(meter) meter.textContent=n; inp.classList.toggle('is-invalid', max&&n>max); }
    inp.addEventListener('input', upd); upd();
  });

  // Delivery button
  (function(){
    const tenant = root?.dataset?.tenant || '';
    const section = root?.dataset?.sectionKey || '';
    const slug = root?.dataset?.entrySlug || '';
    const btn = document.getElementById('z2h-delivery-btn');
    const publishBtn = document.getElementById('z2h-publish-btn');
    if(tenant && section && slug){
      btn.href=`/delivery/v1/tenants/${tenant}/sections/${encodeURIComponent(section)}/entries/${encodeURIComponent(slug)}`;
      btn.classList.remove('d-none');
      publishBtn && publishBtn.classList.remove('d-none');
    }
  })();

  // Publish flow (fix #3: modal over toolbar because of z-indexes)
  (function(){
    const publishBtn = document.getElementById('z2h-publish-btn');
    const publishModalEl = document.getElementById('z2hPublishModal');
    const confirmPublish = document.getElementById('z2h-confirm-publish');
    if (!publishBtn || !publishModalEl || !confirmPublish) return;

    let bsModal = null;
    function setStatusChip(v){
      const chip=document.getElementById('z2h-status-chip');
      if(!chip) return;
      chip.textContent=v;
      chip.classList.remove('published','draft','archived');
      chip.classList.add(v);
    }

    publishBtn.addEventListener('click', ()=>{
      if (isDirty){
        alert('You have unsaved changes. Please press Save before publishing.');
        return;
      }
      const hasSections = document.querySelectorAll('[data-section-index]').length > 0;
      if(!hasSections){
        alert('This page has no sections. Add content before publishing.');
        return;
      }
      bsModal = new bootstrap.Modal(publishModalEl);
      bsModal.show();
    });

    async function callPublish(){
      const entryId  = root.dataset.entryId;
      const res = await fetch(`/admin/pages/${entryId}/publish`, { method: 'POST', headers: { 'X-Requested-With': 'fetch' } });
      if(!res.ok){
        let txt=''; try{ txt = await res.text(); }catch(_){}
        throw new Error(txt || 'Publish failed');
      }
      return res.json().catch(()=> ({}));
    }

    confirmPublish.addEventListener('click', async ()=>{
      confirmPublish.disabled = true;
      try{
        await callPublish();
        setStatusChip('published');
      }catch(err){
        alert(err?.message || 'Publish failed');
      }finally{
        confirmPublish.disabled = false;
      }
    });
  })();

  // Serialize
  function serialize(){
    const out={
      replace: !!document.getElementById('f-replace')?.checked,
      seo: {
        title: document.getElementById('f-seo-title')?.value || '',
        description: document.getElementById('f-seo-desc')?.value || ''
      }
    };
    const sectionPanels = Array.from(document.querySelectorAll('[data-section-index]'));
    if (sectionPanels.length > 0){
      out.sections = [];
      sectionPanels.forEach(panel=>{
        const sec={};
        panel.querySelectorAll('[data-k]').forEach(el=>{
          const k=el.getAttribute('data-k'); let v=el.value;
          if(k==='schema_version') v=Number(v||1);
          if(k){ if(k.includes('[')) setDeep(sec,k,v); else sec[k]=v; }
        });
        ['media','actions'].forEach(rep=>{
          const host=panel.querySelector(`.z2h-repeater[data-repeater="${rep}"]`);
          if(host){
            const arr=[]; host.querySelectorAll('.z2h-rep-item').forEach(item=>arr.push(getRepItemObject(item)));
            if(arr.length) sec[rep]=arr;
          }
        });
        const jsonArea = panel.querySelector('.z2h-json-editor');
        if(jsonArea){
          const txt=jsonArea.value.trim()||'{}';
          try{ const parsed=JSON.parse(txt); if(Object.keys(parsed).length) sec['data']=parsed; jsonArea.classList.remove('is-invalid'); }
          catch(e){ jsonArea.classList.add('is-invalid'); throw new Error('Invalid JSON in Advanced Data'); }
        }
        out.sections.push(sec);
      });
    }
    contentJson.value = JSON.stringify(out);
    return out;
  }

  // Dirty + backup
  let t;
  function onDirty(){
    setDirty(true);
    clearTimeout(t);
    t=setTimeout(()=>{ const obj=serialize(); try{ localStorage.setItem('z2h-edit-backup-'+entryId, JSON.stringify(obj)); }catch{} }, 250);
  }
  document.addEventListener('input', (e)=>{ if(e.target.closest('.z2h-dirty')) onDirty(); });
  document.addEventListener('change', (e)=>{ if(e.target.closest('.z2h-dirty')) onDirty(); });

  // Shortcuts
  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); document.getElementById('z2h-edit-form').requestSubmit(); }
    if(e.key.toLowerCase()==='f'){ document.getElementById('z2h-section-search').focus(); e.preventDefault(); }
  });

  // Submit
  document.getElementById('z2h-edit-form').addEventListener('submit', function(ev){
    try{
      const obj = serialize();
      if (!obj.sections && !obj.replace){
        // no-op
      }
    }catch(err){
      ev.preventDefault(); alert(err.message||'Invalid data'); return;
    }
    try{ localStorage.removeItem('z2h-edit-backup-'+entryId); }catch{}
    setDirty(false);
  });

  // Init
  serialize();
  setDirty(false);
})();
</script>
{% endblock %}
























{% extends "base.html" %}
{% block title %}{% if entry %}Editar{% else %}Nuevo{% endif %} · Editor (fácil){% endblock %}
{% block content %}
<div class="container py-4">
  <a href="/admin/entries{% if entry %}?tenant_id={{ tenant_id }}&section_id={{ section_id }}{% endif %}" class="btn btn-link">&larr; Volver</a>

  <div class="d-flex justify-content-between align-items-center">
    <h1 class="h4 m-0">
      {% if entry %}Editar{% else %}Nuevo{% endif %} (Fácil) ·
      {% if schema_active %}Schema v{{ schema_active.version }}{% else %}Sin schema activo{% endif %}
    </h1>
    <div class="d-flex gap-2">
      {% if entry %}
      <a class="btn btn-outline-secondary" href="/admin/entries/{{ entry.id }}">Modo avanzado (JSON)</a>
      {% endif %}
      {% if entry %}
      <a class="btn btn-owa-outline" target="_blank"
         href="/delivery/v1/tenants/{{ entry.tenant.slug if entry.tenant else '' }}/sections/{{ entry.section.key if entry.section else '' }}/entries/{{ entry.slug }}">
        Ver Delivery
      </a>
      {% endif %}
    </div>
  </div>

  <form class="card p-3 mt-3" method="post"
        action="{% if entry %}/admin/entries/{{ entry.id }}/update_blocks{% else %}/admin/entries/create_blocks{% endif %}">
    <input type="hidden" name="tenant_id" value="{{ tenant_id }}">
    <input type="hidden" name="section_id" value="{{ section_id }}">
    <input type="hidden" id="data_json" name="data_json" value="{}">

    <div class="row g-3">
      <div class="col-12 col-md-4">
        <label class="form-label">Slug</label>
        <input class="form-control" name="slug" required
               value="{{ (entry.slug if entry else '') }}">
        <div class="form-text">Identificador de la página/bloque (ej. <code>home</code>).</div>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Schema version</label>
        <input class="form-control" name="schema_version" type="number" min="1"
               value="{{ entry.schema_version if entry else (schema_active.version if schema_active else 1) }}">
      </div>
      {% if entry %}
      <div class="col-6 col-md-2">
        <label class="form-label">Status</label>
        <select class="form-select" name="status" disabled>
          {% for st in ["draft","published","archived"] %}
            <option value="{{ st }}" {% if entry.status==st %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>
        <div class="form-text">Publica/Despublica desde el listado.</div>
      </div>
      {% endif %}
    </div>

    <hr class="my-4">

    <!-- Replace -->
    <div class="form-check form-switch mb-3">
      <input class="form-check-input" type="checkbox" id="f_replace">
      <label class="form-check-label" for="f_replace">Replace · <span class="text-muted">Activar/Desactivar</span></label>
    </div>

    <!-- SEO -->
    <div class="card mb-4">
      <div class="card-header fw-semibold">SEO</div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Title</label>
            <input class="form-control" id="seo_title" maxlength="70" placeholder="Máx 70 caracteres">
          </div>
          <div class="col-md-6">
            <label class="form-label">Description</label>
            <input class="form-control" id="seo_description" maxlength="160" placeholder="Máx 160 caracteres">
          </div>
        </div>
      </div>
    </div>

    <!-- Sections Builder -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Sections</span>
        <div>
          <button class="btn btn-sm btn-primary" type="button" onclick="addSection()">+ Agregar sección</button>
        </div>
      </div>
      <div class="card-body" id="sections_container">
        <!-- items se inyectan por JS -->
      </div>
    </div>

    <div class="d-flex gap-2 mt-4">
      <button class="btn btn-cta" type="submit" onclick="serializeAndSubmit(event)">Guardar</button>
      {% if entry %}
      <a class="btn btn-outline-secondary"
         href="/delivery/v1/tenants/{{ entry.tenant.slug if entry.tenant else '' }}/sections/{{ entry.section.key if entry.section else '' }}/entries/{{ entry.slug }}"
         target="_blank">Ver Delivery</a>
      {% endif %}
      <a class="btn btn-outline-secondary" href="/admin/entries?tenant_id={{ tenant_id }}&section_id={{ section_id }}">Cancelar</a>
    </div>
  </form>
</div>

<script>
/* ===============================
   Helpers — tipos soportados
   =============================== */
const TYPE_ENUM = [
  "NavBar","HeroTwoUp","IntroBlurbCTAs","DiscoverGrid","TherapiesAccordion",
  "MembershipsGrid","HeroMediaOverlay","SocialGallery","Footer"
];

// Factories por tipo → dibujan subform "data"
function renderDataFields(type, data={}, idx=0){
  switch(type){
    case "NavBar":
      return renderNavBar(data, idx);
    case "HeroTwoUp":
      return renderHeroTwoUp(data, idx);
    case "IntroBlurbCTAs":
      return renderIntroBlurbCTAs(data, idx);
    case "DiscoverGrid":
      return renderDiscoverGrid(data, idx);
    case "TherapiesAccordion":
      return renderTherapiesAccordion(data, idx);
    case "MembershipsGrid":
      return renderMembershipsGrid(data, idx);
    case "HeroMediaOverlay":
      return renderHeroMediaOverlay(data, idx);
    case "SocialGallery":
      return renderSocialGallery(data, idx);
    case "Footer":
      return renderFooter(data, idx);
    default:
      return `<div class="alert alert-secondary">Tipo no soportado aún. Usa modo avanzado (JSON).</div>`;
  }
}

/* ---------- Subforms por tipo (campos clave del schema) ---------- */

function renderNavBar(d={}, idx){
  const brand = d.brand || {};
  const left = d.leftLinks || [];
  const right = d.rightLinks || [];
  return `
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Brand · Text</label>
        <input class="form-control" data-k="brand.text" data-i="${idx}" value="${esc(brand.text||'')}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Brand · Href</label>
        <input class="form-control" data-k="brand.href" data-i="${idx}" value="${esc(brand.href||'/')}">
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label">Left Links</label>
      ${renderLinksTable(left, idx, "leftLinks")}
    </div>
    <div class="mt-3">
      <label class="form-label">Right Links</label>
      ${renderLinksTable(right, idx, "rightLinks")}
    </div>
  `;
}

function renderHeroTwoUp(d={}, idx){
  const overlay=d.overlay||{}, layout=d.layout||{}, media=d.media||[];
  return `
    <div class="mb-3">
      <label class="form-label">Media</label>
      ${renderMediaTable(media, idx, "media")}
    </div>
    <div class="row g-3">
      <div class="col-md-4"><label class="form-label">Overlay · headingPrefix</label>
        <input class="form-control" data-k="overlay.headingPrefix" data-i="${idx}" value="${esc(overlay.headingPrefix||'')}">
      </div>
      <div class="col-md-4"><label class="form-label">Overlay · headingSuffix</label>
        <input class="form-control" data-k="overlay.headingSuffix" data-i="${idx}" value="${esc(overlay.headingSuffix||'')}">
      </div>
      <div class="col-md-4"><label class="form-label">Overlay · fallbackHeading</label>
        <input class="form-control" data-k="overlay.fallbackHeading" data-i="${idx}" value="${esc(overlay.fallbackHeading||'')}">
      </div>
      <div class="col-md-4"><label class="form-label">Overlay · align</label>
        <select class="form-select" data-k="overlay.align" data-i="${idx}">
          ${opts(["left","center","right"], overlay.align||"center")}
        </select>
      </div>
      <div class="col-md-4"><label class="form-label">Overlay · scrimOpacity (0–1)</label>
        <input type="number" step="0.01" min="0" max="1" class="form-control" data-k="overlay.scrimOpacity" data-i="${idx}" value="${overlay.scrimOpacity ?? 0.35}">
      </div>
      <div class="col-md-12">
        <label class="form-label">Overlay · rotatingWords (coma-separado)</label>
        <input class="form-control" data-k="overlay.rotatingWords" data-i="${idx}" value="${esc((overlay.rotatingWords||[]).join(', '))}">
      </div>
    </div>
    <div class="row g-3 mt-2">
      <div class="col-md-4"><label class="form-label">Layout · gap (px)</label>
        <input type="number" class="form-control" data-k="layout.gap" data-i="${idx}" value="${layout.gap ?? 24}">
      </div>
      <div class="col-md-4"><label class="form-label">Layout · ratio</label>
        <input class="form-control" data-k="layout.ratio" data-i="${idx}" value="${esc(layout.ratio||'auto')}">
      </div>
      <div class="col-md-4"><label class="form-label">Layout · stackBreakpoint</label>
        <select class="form-select" data-k="layout.stackBreakpoint" data-i="${idx}">
          ${opts(["sm","md","lg"], layout.stackBreakpoint||"md")}
        </select>
      </div>
    </div>
  `;
}

function renderIntroBlurbCTAs(d={}, idx){
  const ctas = d.ctas||[];
  return `
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Heading</label>
        <input class="form-control" data-k="heading" data-i="${idx}" value="${esc(d.heading||'')}">
      </div>
      <div class="col-md-6">
        <label class="form-label">Align</label>
        <select class="form-select" data-k="align" data-i="${idx}">
          ${opts(["left","center","right"], d.align||"center")}
        </select>
      </div>
      <div class="col-12">
        <label class="form-label">Body</label>
        <textarea class="form-control" rows="3" data-k="body" data-i="${idx}">${esc(d.body||'')}</textarea>
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label">CTAs</label>
      ${renderCTATable(ctas, idx, "ctas")}
    </div>
  `;
}

function renderDiscoverGrid(d={}, idx){
  const items = d.items||[];
  return `
    <div class="row g-3">
      <div class="col-md-6"><label class="form-label">Title</label>
        <input class="form-control" data-k="title" data-i="${idx}" value="${esc(d.title||'')}">
      </div>
      <div class="col-md-3"><label class="form-label">Align</label>
        <select class="form-select" data-k="align" data-i="${idx}">
          ${opts(["left","center","right"], d.align||"left")}
        </select>
      </div>
      <div class="col-12"><label class="form-label">Intro</label>
        <textarea class="form-control" rows="2" data-k="intro" data-i="${idx}">${esc(d.intro||'')}</textarea>
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label">Items</label>
      ${renderDiscoverItemsTable(items, idx, "items")}
    </div>
  `;
}

function renderTherapiesAccordion(d={}, idx){
  const items=d.items||[], side=d.sideImage||{}, layout=d.layout||{}, bottom=d.bottomCallout||{};
  return `
    <div class="row g-3">
      <div class="col-md-6"><label class="form-label">Title</label>
        <input class="form-control" data-k="title" data-i="${idx}" value="${esc(d.title||'')}">
      </div>
      <div class="col-12"><label class="form-label">Intro</label>
        <textarea class="form-control" rows="2" data-k="intro" data-i="${idx}">${esc(d.intro||'')}</textarea>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-md-6"><label class="form-label">SideImage · URL</label>
        <input class="form-control" data-k="sideImage.url" data-i="${idx}" value="${esc(side.url||'')}">
      </div>
      <div class="col-md-6"><label class="form-label">SideImage · Alt</label>
        <input class="form-control" data-k="sideImage.alt" data-i="${idx}" value="${esc(side.alt||'')}">
      </div>
      <div class="col-md-4"><label class="form-label">Layout · mediaPosition</label>
        <select class="form-select" data-k="layout.mediaPosition" data-i="${idx}">
          ${opts(["left","right"], layout.mediaPosition||"right")}
        </select>
      </div>
    </div>

    <div class="mt-3">
      <label class="form-label">Items</label>
      ${renderTherapiesItemsTable(items, idx, "items")}
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-8"><label class="form-label">Bottom Callout · Text</label>
        <input class="form-control" data-k="bottomCallout.text" data-i="${idx}" value="${esc(bottom.text||'')}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Bottom Callout · CTA</label>
        ${renderCTAInline(bottom.cta||{}, idx, "bottomCallout.cta")}
      </div>
    </div>
  `;
}

function renderMembershipsGrid(d={}, idx){
  const items=d.items||[];
  return `
    <div class="row g-3">
      <div class="col-md-6"><label class="form-label">Title</label>
        <input class="form-control" data-k="title" data-i="${idx}" value="${esc(d.title||'')}">
      </div>
      <div class="col-12"><label class="form-label">Intro</label>
        <textarea class="form-control" rows="2" data-k="intro" data-i="${idx}">${esc(d.intro||'')}</textarea>
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label">Items</label>
      ${renderMembershipItemsTable(items, idx, "items")}
    </div>
  `;
}

function renderHeroMediaOverlay(d={}, idx){
  const overlay=d.overlay||{}, media=d.media||[];
  return `
    <div class="mb-3">
      <label class="form-label">Media</label>
      ${renderMediaTable(media, idx, "media")}
    </div>
    <div class="row g-3">
      <div class="col-md-4"><label class="form-label">Overlay · headingPrefix</label>
        <input class="form-control" data-k="overlay.headingPrefix" data-i="${idx}" value="${esc(overlay.headingPrefix||'')}">
      </div>
      <div class="col-md-4"><label class="form-label">Overlay · headingSuffix</label>
        <input class="form-control" data-k="overlay.headingSuffix" data-i="${idx}" value="${esc(overlay.headingSuffix||'')}">
      </div>
      <div class="col-md-4"><label class="form-label">Overlay · fallbackHeading</label>
        <input class="form-control" data-k="overlay.fallbackHeading" data-i="${idx}" value="${esc(overlay.fallbackHeading||'')}">
      </div>
      <div class="col-md-4"><label class="form-label">Overlay · align</label>
        <select class="form-select" data-k="overlay.align" data-i="${idx}">
          ${opts(["left","center","right"], overlay.align||"center")}
        </select>
      </div>
      <div class="col-md-4"><label class="form-label">Overlay · scrimOpacity (0–1)</label>
        <input type="number" step="0.01" min="0" max="1" class="form-control" data-k="overlay.scrimOpacity" data-i="${idx}" value="${overlay.scrimOpacity ?? 0.25}">
      </div>
      <div class="col-md-12">
        <label class="form-label">Overlay · rotatingWords (coma-separado)</label>
        <input class="form-control" data-k="overlay.rotatingWords" data-i="${idx}" value="${esc((overlay.rotatingWords||[]).join(', '))}">
      </div>
    </div>
  `;
}

function renderSocialGallery(d={}, idx){
  const images=d.images||[];
  return `
    <div class="row g-3">
      <div class="col-md-4"><label class="form-label">Heading</label>
        <input class="form-control" data-k="heading" data-i="${idx}" value="${esc(d.heading||'')}">
      </div>
      <div class="col-md-4"><label class="form-label">Handle</label>
        <input class="form-control" data-k="handle" data-i="${idx}" value="${esc(d.handle||'')}">
      </div>
      <div class="col-md-4"><label class="form-label">Profile URL</label>
        <input class="form-control" data-k="profileUrl" data-i="${idx}" value="${esc(d.profileUrl||'')}">
      </div>
      <div class="col-md-4"><label class="form-label">Source</label>
        <select class="form-select" data-k="source" data-i="${idx}">
          ${opts(["manual","instagram","cms"], d.source||"manual")}
        </select>
      </div>
    </div>
    <div class="mt-3">
      <label class="form-label">Images</label>
      ${renderImageTable(images, idx, "images")}
    </div>
  `;
}

function renderFooter(d={}, idx){
  const contact=d.contact||{}, newsletter=d.newsletter||{}, bottom=d.bottomBar||{}, groups=d.groups||[];
  return `
    <div class="row g-3">
      <div class="col-md-4"><label class="form-label">Title</label>
        <input class="form-control" data-k="title" data-i="${idx}" value="${esc(d.title||'')}">
      </div>
    </div>

    <div class="mt-3">
      <div class="fw-semibold mb-2">Contact</div>
      <div class="row g-3">
        <div class="col-md-6"><label class="form-label">Heading</label>
          <input class="form-control" data-k="contact.heading" data-i="${idx}" value="${esc(contact.heading||'')}">
        </div>
        <div class="col-md-6"><label class="form-label">Email</label>
          <input class="form-control" data-k="contact.email" data-i="${idx}" value="${esc(contact.email||'')}">
        </div>
        <div class="col-md-6"><label class="form-label">Email Href</label>
          <input class="form-control" data-k="contact.emailHref" data-i="${idx}" value="${esc(contact.emailHref||'')}">
        </div>
        <div class="col-md-6"><label class="form-label">Phone</label>
          <input class="form-control" data-k="contact.phone" data-i="${idx}" value="${esc(contact.phone||'')}">
        </div>
        <div class="col-md-6"><label class="form-label">Phone Href</label>
          <input class="form-control" data-k="contact.phoneHref" data-i="${idx}" value="${esc(contact.phoneHref||'')}">
        </div>
        <div class="col-12"><label class="form-label">Address Lines (una por línea)</label>
          <textarea class="form-control" rows="2" data-k="contact.addressLines" data-i="${idx}">${esc((contact.addressLines||[]).join('\n'))}</textarea>
        </div>
      </div>
    </div>

    <div class="mt-3">
      <div class="fw-semibold mb-2">Groups</div>
      ${renderGroupsTable(groups, idx, "groups")}
    </div>

    <div class="mt-3">
      <div class="fw-semibold mb-2">Newsletter</div>
      <div class="row g-3">
        <div class="col-md-6"><label class="form-label">Heading</label>
          <input class="form-control" data-k="newsletter.heading" data-i="${idx}" value="${esc(newsletter.heading||'')}">
        </div>
        <div class="col-md-6"><label class="form-label">Subtext</label>
          <input class="form-control" data-k="newsletter.subtext" data-i="${idx}" value="${esc(newsletter.subtext||'')}">
        </div>
        <div class="col-md-6"><label class="form-label">Action</label>
          <input class="form-control" data-k="newsletter.action" data-i="${idx}" value="${esc(newsletter.action||'')}">
        </div>
        <div class="col-md-6"><label class="form-label">Placeholder</label>
          <input class="form-control" data-k="newsletter.placeholder" data-i="${idx}" value="${esc(newsletter.placeholder||'')}">
        </div>
        <div class="col-md-6"><label class="form-label">Submit Href</label>
          <input class="form-control" data-k="newsletter.submitHref" data-i="${idx}" value="${esc(newsletter.submitHref||'')}">
        </div>
      </div>
    </div>

    <div class="mt-3">
      <div class="fw-semibold mb-2">Bottom Bar</div>
      <div class="row g-3">
        <div class="col-md-6"><label class="form-label">Left Note</label>
          <input class="form-control" data-k="bottomBar.leftNote" data-i="${idx}" value="${esc(bottom.leftNote||'')}">
        </div>
        <div class="col-md-6"><label class="form-label">Copyright</label>
          <input class="form-control" data-k="bottomBar.copyright" data-i="${idx}" value="${esc(bottom.copyright||'')}">
        </div>
      </div>
      <div class="mt-2">
        <label class="form-label">Legal Links</label>
        ${renderLinksTable(bottom.legalLinks||[], idx, "bottomBar.legalLinks")}
      </div>
    </div>
  `;
}

/* ---------- Widgets reutilizables (tablas dinámicas) ---------- */

function renderLinksTable(rows, idx, key){
  let html = `
    <table class="table align-middle">
      <thead><tr><th>Label</th><th>Href</th><th style="width:110px;">Ext</th><th style="width:120px;"></th></tr></thead>
      <tbody>`;
  (rows||[]).forEach((r,i)=>{
    html += `<tr>
      <td><input class="form-control" data-k="${key}[${i}].label" data-i="${idx}" value="${esc(r.label||'')}"></td>
      <td><input class="form-control" data-k="${key}[${i}].href" data-i="${idx}" value="${esc(r.href||'')}"></td>
      <td><select class="form-select" data-k="${key}[${i}].external" data-i="${idx}">
            ${opts(["","true","false"], String(r.external??""))}
          </select></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>
           <button type="button" class="btn btn-sm btn-outline-primary" onclick="addLinkRow(this,'${key}',${idx})">+ Agregar link</button>`;
  return html;
}

function renderCTATable(rows, idx, key){
  let html = `
    <table class="table align-middle">
      <thead><tr><th>Label</th><th>Href</th><th>Style</th><th style="width:120px;"></th></tr></thead>
      <tbody>`;
  (rows||[]).forEach((r,i)=>{
    html += `<tr>
      <td><input class="form-control" data-k="${key}[${i}].label" data-i="${idx}" value="${esc(r.label||'')}"></td>
      <td><input class="form-control" data-k="${key}[${i}].href" data-i="${idx}" value="${esc(r.href||'')}"></td>
      <td><select class="form-select" data-k="${key}[${i}].style" data-i="${idx}">
            ${opts(["primary","outline","link"], r.style||"outline")}
          </select></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>
           <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCTARow(this,'${key}',${idx})">+ Agregar CTA</button>`;
  return html;
}

function renderCTAInline(r, idx, key){
  return `
    <div class="input-group">
      <input class="form-control" placeholder="Label" data-k="${key}.label" data-i="${idx}" value="${esc(r.label||'')}">
      <input class="form-control" placeholder="Href" data-k="${key}.href" data-i="${idx}" value="${esc(r.href||'')}">
      <select class="form-select" data-k="${key}.style" data-i="${idx}">
        ${opts(["primary","outline","link"], r.style||"outline")}
      </select>
    </div>
  `;
}

function renderMediaTable(rows, idx, key){
  let html = `
    <table class="table align-middle">
      <thead><tr><th>Type</th><th>URL</th><th>Alt</th><th style="width:120px;"></th></tr></thead>
      <tbody>`;
  (rows||[]).forEach((r,i)=>{
    html += `<tr>
      <td><select class="form-select" data-k="${key}[${i}].type" data-i="${idx}">
            ${opts(["image","video"], r.type||"image")}
          </select></td>
      <td><input class="form-control" data-k="${key}[${i}].url" data-i="${idx}" value="${esc(r.url||'')}"></td>
      <td><input class="form-control" data-k="${key}[${i}].alt" data-i="${idx}" value="${esc(r.alt||'')}"></td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>
           <button type="button" class="btn btn-sm btn-outline-primary" onclick="addMediaRow(this,'${key}',${idx})">+ Agregar media</button>`;
  return html;
}

function renderDiscoverItemsTable(rows, idx, key){
  let html = `
    <table class="table align-middle">
      <thead><tr><th>Image</th><th>Alt</th><th>Title</th><th>Description</th><th>CTA</th><th style="width:120px;"></th></tr></thead>
      <tbody>`;
  (rows||[]).forEach((r,i)=>{
    const c = r.cta || {};
    html += `<tr>
      <td><input class="form-control" data-k="${key}[${i}].image" data-i="${idx}" value="${esc(r.image||'')}"></td>
      <td><input class="form-control" data-k="${key}[${i}].imageAlt" data-i="${idx}" value="${esc(r.imageAlt||'')}"></td>
      <td><input class="form-control" data-k="${key}[${i}].title" data-i="${idx}" value="${esc(r.title||'')}"></td>
      <td><textarea class="form-control" rows="2" data-k="${key}[${i}].description" data-i="${idx}">${esc(r.description||'')}</textarea></td>
      <td>
        <input class="form-control mb-1" placeholder="CTA label" data-k="${key}[${i}].cta.label" data-i="${idx}" value="${esc(c.label||'')}">
        <input class="form-control mb-1" placeholder="CTA href" data-k="${key}[${i}].cta.href" data-i="${idx}" value="${esc(c.href||'')}">
        <select class="form-select" data-k="${key}[${i}].cta.style" data-i="${idx}">
          ${opts(["primary","outline","link"], c.style||"outline")}
        </select>
      </td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>
           <button type="button" class="btn btn-sm btn-outline-primary" onclick="addDiscoverRow(this,'${key}',${idx})">+ Agregar item</button>`;
  return html;
}

function renderTherapiesItemsTable(rows, idx, key){
  let html = `
    <table class="table align-middle">
      <thead><tr><th>Title</th><th>Description</th><th>Benefits (una por línea)</th><th>CTA</th><th style="width:120px;"></th></tr></thead>
      <tbody>`;
  (rows||[]).forEach((r,i)=>{
    const c = r.cta || {};
    html += `<tr>
      <td><input class="form-control" data-k="${key}[${i}].title" data-i="${idx}" value="${esc(r.title||'')}"></td>
      <td><textarea class="form-control" rows="2" data-k="${key}[${i}].description" data-i="${idx}">${esc(r.description||'')}</textarea></td>
      <td><textarea class="form-control" rows="2" data-k="${key}[${i}].benefits" data-i="${idx}">${esc((r.benefits||[]).join('\n'))}</textarea></td>
      <td>
        <input class="form-control mb-1" placeholder="CTA label" data-k="${key}[${i}].cta.label" data-i="${idx}" value="${esc(c.label||'')}">
        <input class="form-control mb-1" placeholder="CTA href" data-k="${key}[${i}].cta.href" data-i="${idx}" value="${esc(c.href||'')}">
        <select class="form-select" data-k="${key}[${i}].cta.style" data-i="${idx}">
          ${opts(["primary","outline","link"], c.style||"outline")}
        </select>
      </td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>
           <button type="button" class="btn btn-sm btn-outline-primary" onclick="addTherapyRow(this,'${key}',${idx})">+ Agregar terapia</button>`;
  return html;
}

function renderMembershipItemsTable(rows, idx, key){
  let html = `
    <table class="table align-middle">
      <thead><tr><th>#</th><th>Image</th><th>Alt</th><th>Title</th><th>Description</th><th>CTA</th><th style="width:120px;"></th></tr></thead>
      <tbody>`;
  (rows||[]).forEach((r,i)=>{
    const c = r.cta || {};
    html += `<tr>
      <td><input class="form-control" data-k="${key}[${i}].indexLabel" data-i="${idx}" value="${esc(r.indexLabel||'')}"></td>
      <td><input class="form-control" data-k="${key}[${i}].image" data-i="${idx}" value="${esc(r.image||'')}"></td>
      <td><input class="form-control" data-k="${key}[${i}].imageAlt" data-i="${idx}" value="${esc(r.imageAlt||'')}"></td>
      <td><input class="form-control" data-k="${key}[${i}].title" data-i="${idx}" value="${esc(r.title||'')}"></td>
      <td><textarea class="form-control" rows="2" data-k="${key}[${i}].description" data-i="${idx}">${esc(r.description||'')}</textarea></td>
      <td>
        <input class="form-control mb-1" placeholder="CTA label" data-k="${key}[${i}].cta.label" data-i="${idx}" value="${esc(c.label||'')}">
        <input class="form-control mb-1" placeholder="CTA href" data-k="${key}[${i}].cta.href" data-i="${idx}" value="${esc(c.href||'')}">
        <select class="form-select" data-k="${key}[${i}].cta.style" data-i="${idx}">
          ${opts(["primary","outline","link"], c.style||"outline")}
        </select>
      </td>
      <td class="text-end">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>
           <button type="button" class="btn btn-sm btn-outline-primary" onclick="addMembershipRow(this,'${key}',${idx})">+ Agregar plan</button>`;
  return html;
}

function renderImageTable(rows, idx, key){
  let html = `
    <table class="table align-middle">
      <thead><tr><th>URL</th><th>Alt</th><th style="width:120px;"></th></tr></thead>
      <tbody>`;
  (rows||[]).forEach((r,i)=>{
    html += `<tr>
      <td><input class="form-control" data-k="${key}[${i}].url" data-i="${idx}" value="${esc(r.url||'')}"></td>
      <td><input class="form-control" data-k="${key}[${i}].alt" data-i="${idx}" value="${esc(r.alt||'')}"></td>
      <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button></td>
    </tr>`;
  });
  html += `</tbody></table>
           <button type="button" class="btn btn-sm btn-outline-primary" onclick="addImageRow(this,'${key}',${idx})">+ Agregar imagen</button>`;
  return html;
}

function renderGroupsTable(rows, idx, key){
  let html = `
    <table class="table align-middle">
      <thead><tr><th>Heading</th><th>Links</th><th style="width:120px;"></th></tr></thead>
      <tbody>`;
  (rows||[]).forEach((r,i)=>{
    html += `<tr>
      <td><input class="form-control" data-k="${key}[${i}].heading" data-i="${idx}" value="${esc(r.heading||'')}"></td>
      <td>${renderLinksTable(r.links||[], idx, `${key}[${i}].links`)}</td>
      <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button></td>
    </tr>`;
  });
  html += `</tbody></table>
           <button type="button" class="btn btn-sm btn-outline-primary" onclick="addGroupRow(this,'${key}',${idx})">+ Agregar grupo</button>`;
  return html;
}

/* ---------- Secciones (wrapper) ---------- */

let sections = []; // estado local

function addSection(prefill){
  const idx = sections.length;
  const item = prefill || { type:"NavBar", schema_version:1, data:{} };
  sections.push(item);
  const wrap = document.createElement('div');
  wrap.className = "border rounded p-3 mb-3";
  wrap.dataset.idx = idx;

  wrap.innerHTML = `
    <div class="d-flex justify-content-between align-items-center">
      <div class="fw-semibold">Sección #${idx+1}</div>
      <div class="btn-group">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveUp(${idx})">↑</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveDown(${idx})">↓</button>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSection(${idx})">Eliminar</button>
      </div>
    </div>

    <div class="row g-3 mt-2">
      <div class="col-md-4">
        <label class="form-label">Type</label>
        <select class="form-select" data-section="${idx}" data-field="type" onchange="onTypeChange(${idx}, this.value)">
          ${opts(TYPE_ENUM, item.type)}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Schema version</label>
        <input type="number" min="1" class="form-control" data-section="${idx}" data-field="schema_version" value="${item.schema_version||1}">
      </div>
    </div>

    <div class="mt-3" id="data_area_${idx}">
      ${renderDataFields(item.type, item.data||{}, idx)}
    </div>
  `;

  document.getElementById('sections_container').appendChild(wrap);
}

function onTypeChange(idx, type){
  const area = document.getElementById(`data_area_${idx}`);
  if(!area) return;
  area.innerHTML = renderDataFields(type, {}, idx);
  sections[idx].type = type;
}

function moveUp(idx){
  if(idx<=0) return;
  const tmp = sections[idx-1]; sections[idx-1] = sections[idx]; sections[idx] = tmp;
  refreshSectionsUI();
}
function moveDown(idx){
  if(idx>=sections.length-1) return;
  const tmp = sections[idx+1]; sections[idx+1] = sections[idx]; sections[idx] = tmp;
  refreshSectionsUI();
}
function removeSection(idx){
  sections.splice(idx,1);
  refreshSectionsUI();
}
function refreshSectionsUI(){
  document.getElementById('sections_container').innerHTML = "";
  const arr = sections.slice();
  sections = [];
  arr.forEach(s => addSection(s));
}

/* ---------- Serialización ---------- */

function getVal(el){
  if(el.tagName === "SELECT"){
    const v = el.value;
    if(v==="true") return true;
    if(v==="false") return false;
    return v;
  }
  return el.value;
}

function serializeSections(){
  const out = [];
  const wraps = document.querySelectorAll('#sections_container > div.border');
  wraps.forEach(wrap=>{
    const idx = parseInt(wrap.dataset.idx);
    const typeSel = wrap.querySelector('[data-field="type"]');
    const verInp = wrap.querySelector('[data-field="schema_version"]');
    const type = typeSel ? typeSel.value : "NavBar";
    const schema_version = verInp ? parseInt(verInp.value||"1") : 1;

    const data = {};
    // todos los inputs que pertenecen a este idx:
    const fields = wrap.querySelectorAll(`[data-i="${idx}"][data-k]`);
    fields.forEach(f=>{
      const k = f.getAttribute('data-k');  // ej: overlay.headingPrefix o items[0].title
      setDeep(data, k, getVal(f));
    });

    // normaliza listas coma/lin por los widgets específicos
    normalizeSpecialArrays(data);

    out.push({ type, schema_version, data });
  });
  return out;
}

function setDeep(obj, path, val){
  // soporta puntos y arrays: items[0].title
  const parts = path.split('.');
  let cur = obj;
  for(let i=0;i<parts.length;i++){
    const part = parts[i];
    const m = part.match(/^(.+)\[(\d+)\]$/);
    if(m){
      const key=m[1], idx=parseInt(m[2]);
      if(!Array.isArray(cur[key])) cur[key]=[];
      if(!cur[key][idx]) cur[key][idx] = {};
      if(i===parts.length-1){ cur[key][idx]=val; return; }
      cur = cur[key][idx];
    }else{
      if(i===parts.length-1){ cur[part]=val; return; }
      if(typeof cur[part] !== 'object' || cur[part]===null) cur[part]={};
      cur = cur[part];
    }
  }
}

function normalizeSpecialArrays(data){
  // rotatingWords: string coma-separada → array
  if(data.overlay && typeof data.overlay.rotatingWords === "string"){
    data.overlay.rotatingWords = data.overlay.rotatingWords.split(',').map(s=>s.trim()).filter(Boolean);
  }
  // benefits (textarea líneas) → array
  if(data.items && Array.isArray(data.items)){
    data.items.forEach(it=>{
      if(typeof it.benefits === "string"){
        it.benefits = it.benefits.split('\n').map(s=>s.trim()).filter(Boolean);
      }
    });
  }
}

function serializeAndSubmit(ev){
  // Construye el objeto completo { replace, seo, sections }
  const payload = {};
  payload.replace = document.getElementById('f_replace').checked;

  const seo = {};
  const st = document.getElementById('seo_title').value.trim();
  const sd = document.getElementById('seo_description').value.trim();
  if(st) seo.title = st;
  if(sd) seo.description = sd;
  if(Object.keys(seo).length>0) payload.seo = seo;

  payload.sections = serializeSections();

  document.getElementById('data_json').value = JSON.stringify(payload);
  // deja que el form continúe
}

/* ---------- Utilidades UI ---------- */

function esc(s){ return (s??"").toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
function opts(arr, val){ return arr.map(x=>`<option ${x===val?'selected':''} value="${x}">${x||'—'}</option>`).join(''); }
function delRow(btn){ const tr=btn.closest('tr'); tr.parentNode.removeChild(tr); }
function addRow(btn, maker){ const tbody=btn.closest('.card, .table, .mt-3, .mb-3, .container').querySelector('tbody') || btn.previousElementSibling.querySelector('tbody'); if(!tbody) return; tbody.insertAdjacentHTML('beforeend', maker(tbody.rows.length)); }

/* Row creators — ligados a tablas específicas */
function addLinkRow(btn, key, idx){ addRow(btn, i => `
  <tr>
    <td><input class="form-control" data-k="${key}[${i}].label" data-i="${idx}"></td>
    <td><input class="form-control" data-k="${key}[${i}].href" data-i="${idx}"></td>
    <td><select class="form-select" data-k="${key}[${i}].external" data-i="${idx}">${opts(["","","true","false"], "")}</select></td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button></td>
  </tr>` );
}
function addCTARow(btn, key, idx){ addRow(btn, i => `
  <tr>
    <td><input class="form-control" data-k="${key}[${i}].label" data-i="${idx}"></td>
    <td><input class="form-control" data-k="${key}[${i}].href" data-i="${idx}"></td>
    <td><select class="form-select" data-k="${key}[${i}].style" data-i="${idx}">${opts(["primary","outline","link"], "outline")}</select></td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button></td>
  </tr>` );
}
function addMediaRow(btn, key, idx){ addRow(btn, i => `
  <tr>
    <td><select class="form-select" data-k="${key}[${i}].type" data-i="${idx}">${opts(["image","video"], "image")}</select></td>
    <td><input class="form-control" data-k="${key}[${i}].url" data-i="${idx}"></td>
    <td><input class="form-control" data-k="${key}[${i}].alt" data-i="${idx}"></td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button></td>
  </tr>` );
}
function addDiscoverRow(btn, key, idx){ addRow(btn, i => `
  <tr>
    <td><input class="form-control" data-k="${key}[${i}].image" data-i="${idx}"></td>
    <td><input class="form-control" data-k="${key}[${i}].imageAlt" data-i="${idx}"></td>
    <td><input class="form-control" data-k="${key}[${i}].title" data-i="${idx}"></td>
    <td><textarea class="form-control" rows="2" data-k="${key}[${i}].description" data-i="${idx}"></textarea></td>
    <td>
      <input class="form-control mb-1" placeholder="CTA label" data-k="${key}[${i}].cta.label" data-i="${idx}">
      <input class="form-control mb-1" placeholder="CTA href" data-k="${key}[${i}].cta.href" data-i="${idx}">
      <select class="form-select" data-k="${key}[${i}].cta.style" data-i="${idx}">${opts(["primary","outline","link"], "outline")}</select>
    </td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button></td>
  </tr>` );
}
function addTherapyRow(btn, key, idx){ addRow(btn, i => `
  <tr>
    <td><input class="form-control" data-k="${key}[${i}].title" data-i="${idx}"></td>
    <td><textarea class="form-control" rows="2" data-k="${key}[${i}].description" data-i="${idx}"></textarea></td>
    <td><textarea class="form-control" rows="2" data-k="${key}[${i}].benefits" data-i="${idx}"></textarea></td>
    <td>
      <input class="form-control mb-1" placeholder="CTA label" data-k="${key}[${i}].cta.label" data-i="${idx}">
      <input class="form-control mb-1" placeholder="CTA href" data-k="${key}[${i}].cta.href" data-i="${idx}">
      <select class="form-select" data-k="${key}[${i}].cta.style" data-i="${idx}">${opts(["primary","outline","link"], "outline")}</select>
    </td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button></td>
  </tr>` );
}
function addMembershipRow(btn, key, idx){ addRow(btn, i => `
  <tr>
    <td><input class="form-control" data-k="${key}[${i}].indexLabel" data-i="${idx}"></td>
    <td><input class="form-control" data-k="${key}[${i}].image" data-i="${idx}"></td>
    <td><input class="form-control" data-k="${key}[${i}].imageAlt" data-i="${idx}"></td>
    <td><input class="form-control" data-k="${key}[${i}].title" data-i="${idx}"></td>
    <td><textarea class="form-control" rows="2" data-k="${key}[${i}].description" data-i="${idx}"></textarea></td>
    <td>
      <input class="form-control mb-1" placeholder="CTA label" data-k="${key}[${i}].cta.label" data-i="${idx}">
      <input class="form-control mb-1" placeholder="CTA href" data-k="${key}[${i}].cta.href" data-i="${idx}">
      <select class="form-select" data-k="${key}[${i}].cta.style" data-i="${idx}">${opts(["primary","outline","link"], "outline")}</select>
    </td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button></td>
  </tr>` );
}
function addImageRow(btn, key, idx){ addRow(btn, i => `
  <tr>
    <td><input class="form-control" data-k="${key}[${i}].url" data-i="${idx}"></td>
    <td><input class="form-control" data-k="${key}[${i}].alt" data-i="${idx}"></td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button></td>
  </tr>` );
}
function addGroupRow(btn, key, idx){ addRow(btn, i => `
  <tr>
    <td><input class="form-control" data-k="${key}[${i}].heading" data-i="${idx}"></td>
    <td>${renderLinksTable([], idx, `${key}[${i}].links`)}</td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="delRow(this)">Eliminar</button></td>
  </tr>` );
}

/* ---------- Precarga desde entry.data ---------- */

function preload(){
  const data = {{ (entry.data | tojson) if entry else '{}' | safe }};
  const rep = !!(data && data.replace===true);
  document.getElementById('f_replace').checked = rep;

  if(data && data.seo){
    document.getElementById('seo_title').value = data.seo.title || "";
    document.getElementById('seo_description').value = data.seo.description || "";
  }

  sections = [];
  const sec = (data && Array.isArray(data.sections)) ? data.sections : [];
  if(sec.length === 0){
    addSection(); // al menos una
  } else {
    sec.forEach(s => addSection(s));
  }
}

document.addEventListener('DOMContentLoaded', preload);
</script>
{% endblock %}


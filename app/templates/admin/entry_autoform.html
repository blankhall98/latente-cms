<!--app/templates/admin/entry_autoform.html-->
{% extends "base.html" %}
{% block title %}Editar entry · Latente CMS{% endblock %}

{% block content %}

<section class="card z2h-card p-3 p-md-4 mb-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
    <div>
      <div class="z2h-brand--badge mb-1">Editor</div>
      <h1 class="h4 m-0">Editar: <code>{{ entry.slug }}</code></h1>
      <div class="text-muted small">
        Tenant #{{ tenant_id }} · Section #{{ section_id }} · Schema v{{ schema_version }}
      </div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <!-- Preview -->
      <a class="btn btn-outline" href="/admin/entries/{{ entry.id }}/preview">
        Preview
      </a>
      <!-- Publicar -->
      <form method="post" action="/admin/entries/{{ entry.id }}/publish">
        <button type="submit" class="btn btn-primary">Publicar</button>
      </form>
    </div>
  </div>
</section>

<section class="card z2h-card p-3 p-md-4">
  <form method="post" action="/admin/entries/{{ entry.id }}/save" id="autoform">
    <!-- Metadatos básicos -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label class="form-label">Slug</label>
        <input type="text" name="slug" class="form-control" value="{{ entry.slug }}" required />
      </div>
      <div class="col-md-6">
        <label class="form-label">Schema version</label>
        <input type="number" name="schema_version" class="form-control" value="{{ schema_version }}" />
      </div>
    </div>

    <div class="z2h-divider my-3"></div>

    <!-- Campos generados por schema (ui_hints) -->
    <div class="row g-3">
      {% if ui_hints and ui_hints|length > 0 %}
        {% for f in ui_hints %}
          {# f: {kind, name, label, help, type, choices?, path[] } #}
          {% set current_value = values_map.get(f.name) %}

          <div class="col-12">
            <label class="form-label">{{ f.label }}</label>

            {% if f.kind == "enum" %}
              <select name="f__{{ f.name }}" class="form-control">
                {% for opt in f.choices %}
                  <option value="{{ opt }}" {% if current_value == opt %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
              </select>

            {% elif f.kind == "scalar" %}
              {% if f.type == "checkbox" %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="f__{{ f.name }}" value="true"
                         {% if current_value in [True, "true", "on", 1, "1"] %}checked{% endif %}/>
                  {% if f.help %}<div class="small text-muted mt-1">{{ f.help }}</div>{% endif %}
                </div>
              {% else %}
                <input
                  class="form-control"
                  type="{{ f.type or 'text' }}"
                  name="f__{{ f.name }}"
                  value="{% if current_value is not none %}{{ current_value }}{% endif %}"
                />
                {% if f.help %}
                  <div class="small text-muted mt-1">{{ f.help }}</div>
                {% endif %}
              {% endif %}

            {% elif f.kind == "csv" %}
              <input
                class="form-control"
                type="text"
                name="f__{{ f.name }}"
                value="{% if current_value %}{{ current_value|join(', ') }}{% endif %}"
              />
              {% if f.help %}
                <div class="small text-muted mt-1">{{ f.help }}</div>
              {% else %}
                <div class="small text-muted mt-1">Valores separados por coma.</div>
              {% endif %}

            {% elif f.kind == "unsupported" %}
              <div class="alert alert-light border">
                <div class="small mb-1 text-muted">No soportado en el autoform:</div>
                <code class="d-inline-block">{{ f.name }}</code>
                <div class="small text-muted">Motivo: {{ f.why }}</div>
              </div>

            {% else %}
              <input class="form-control" type="text" name="f__{{ f.name }}"
                     value="{% if current_value is not none %}{{ current_value }}{% endif %}" />
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted">No hay campos soportados por el autoform para el schema activo.</div>
      {% endif %}
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4">
      <a class="btn btn-outline" href="/admin/entries?tenant_id={{ tenant_id }}">Cancelar</a>
      <button class="btn btn-primary" type="submit">Guardar cambios</button>
    </div>
  </form>
</section>

<!-- Panel JSON opcional (colapsable) -->
<section class="card z2h-card p-3 p-md-4 mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="h6 m-0">Vista JSON (solo lectura)</h2>
    <button class="btn btn-sm btn-outline" id="toggle-json">Mostrar/ocultar</button>
  </div>
  <pre id="json-view" class="mt-3" style="display:none; white-space:pre-wrap;">{{ entry.data | tojson(indent=2) }}</pre>
</section>

<script>
  document.getElementById('toggle-json')?.addEventListener('click', function(){
    const el = document.getElementById('json-view');
    if(!el) return;
    el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
  });

  // Normaliza checkboxes (si no marcados, no llegan en POST). Podrías añadir inputs ocultos si lo prefieres.
  document.getElementById('autoform')?.addEventListener('submit', function(e){
    // No-op por ahora.
  });
</script>

{% endblock %}

{% extends "base.html" %}
{% block title %}Dashboard · Latente CMS{% endblock %}

{% block content %}

<section class="z2h-dash-hero card z2h-card mb-4 p-4 p-md-5">
  <div class="row align-items-center g-4">
    <div class="col-lg-8">
      <h1 class="z2h-hero-title mb-1">
        Hola, {{ user.email if user and user.email else "Bienvenido" }}.
      </h1>
      <p class="lead mb-3 text-muted">
        {% if current_tenant %}
          Estás en <strong>{{ current_tenant.name or current_tenant.slug }}</strong>. Administra tu contenido, prévisualiza cambios y publícalos con seguridad.
        {% else %}
          Selecciona un proyecto (tenant) para comenzar a editar y publicar contenido.
        {% endif %}
      </p>
      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-primary" href="/admin/entries{% if current_tenant %}?tenant_id={{ current_tenant.id }}{% endif %}">Entrar a Entries</a>
        <a class="btn btn-outline" href="/admin/tenants">Ver Proyectos</a>
        <a class="btn btn-outline" href="/delivery/v1/entries" target="_blank" rel="noopener">Ver Delivery</a>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="z2h-kpis">
        <!-- KPI: Proyectos visibles en contexto (para superadmin = todos) -->
        <div class="z2h-kpi">
          <div class="z2h-kpi-label">Proyectos</div>
          <div class="z2h-kpi-value">
            {{ tenants_ctx|length if tenants_ctx else 0 }}
            <span class="z2h-kpi-suffix">total</span>
          </div>
        </div>
        <!-- KPI: Secciones del tenant actual -->
        <div class="z2h-kpi">
          <div class="z2h-kpi-label">Secciones</div>
          <div class="z2h-kpi-value">
            {{ sections|length if sections is defined and sections else 0 }}
            <span class="z2h-kpi-suffix">en tenant</span>
          </div>
        </div>
        <!-- KPI: Publicados del tenant actual -->
        <div class="z2h-kpi">
          <div class="z2h-kpi-label">Publicados</div>
          <div class="z2h-kpi-value">
            {{ published_count if published_count is defined else 0 }}
            <span class="z2h-kpi-suffix">entries</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Quick actions + Context lists -->
<div class="row g-4">

  <!-- Tus proyectos (usa tenants_ctx: superadmin ve todos) -->
  <div class="col-12 col-lg-7">
    <div class="card z2h-card p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 m-0">Tus proyectos</h2>
        <a href="/admin/tenants" class="btn btn-sm btn-outline">Ver todos</a>
      </div>

      {% if tenants_ctx and tenants_ctx|length > 0 %}
        <div class="z2h-card-list">
          {% for t in tenants_ctx[:8] %}
            <div class="z2h-list-item">
              <div>
                <div class="z2h-list-title">{{ t.name or t.slug }}</div>
                <div class="z2h-list-sub text-muted">slug: {{ t.slug }} · id: {{ t.id }}</div>
              </div>
              <div class="d-flex gap-2">
                <form method="post" action="/admin/switch-tenant">
                  <input type="hidden" name="tenant_id" value="{{ t.id }}"/>
                  <button class="btn btn-sm btn-outline" type="submit">Entrar</button>
                </form>
                <a class="btn btn-sm btn-outline" href="/delivery/v1/entries?tenant_slug={{ t.slug }}" target="_blank" rel="noopener">
                  Delivery
                </a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">
          {% if user and user.is_superadmin %}
            No hay proyectos registrados todavía.
          {% else %}
            Aún no tienes proyectos asignados.
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Secciones del tenant actual -->
  <div class="col-12 col-lg-5">
    <div class="card z2h-card p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 m-0">Secciones del tenant actual</h2>
        {% if current_tenant %}
          <a href="/admin/entries?tenant_id={{ current_tenant.id }}" class="btn btn-sm btn-outline">Ver entries</a>
        {% endif %}
      </div>

      {% if sections is defined and sections and sections|length > 0 %}
        <div class="z2h-card-list">
          {% for s in sections[:8] %}
            <div class="z2h-list-item">
              <div>
                <div class="z2h-list-title">{{ s.name or s.key }}</div>
                <div class="z2h-list-sub text-muted">key: {{ s.key }} · id: {{ s.id }}</div>
              </div>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-outline" href="/admin/entries?tenant_id={{ current_tenant.id }}&section_id={{ s.id }}">Abrir</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">
          {% if current_tenant %}Este proyecto aún no tiene secciones.{% else %}Selecciona un proyecto para ver secciones.{% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Actividad reciente -->
  <div class="col-12">
    <div class="card z2h-card p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h5 m-0">Últimos cambios</h2>
        <a href="/admin/entries{% if current_tenant %}?tenant_id={{ current_tenant.id }}{% endif %}" class="btn btn-sm btn-outline">Ir a entries</a>
      </div>

      {% if recent_activity is defined and recent_activity and recent_activity|length > 0 %}
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Sección</th>
                <th>Slug</th>
                <th>Estatus</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for it in recent_activity[:10] %}
                <tr>
                  <td class="text-muted">{{ it.when }}</td>
                  <td>{{ it.section_key }}</td>
                  <td><code>{{ it.slug }}</code></td>
                  <td><span class="badge z2h-badge">{{ it.status }}</span></td>
                  <td>
                    <div class="d-flex gap-2">
                      <a class="btn btn-sm btn-outline" href="/admin/entries/{{ it.entry_id }}?tenant_id={{ it.tenant_id }}">Abrir</a>
                      {% if it.slug and it.section_key and it.tenant_slug %}
                        <a class="btn btn-sm btn-outline" href="/delivery/v1/tenants/{{ it.tenant_slug }}/sections/{{ it.section_key }}/entries/{{ it.slug }}" target="_blank" rel="noopener">Delivery</a>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-muted">Sin actividad reciente.</div>
      {% endif %}
    </div>
  </div>

</div>

{% endblock %}




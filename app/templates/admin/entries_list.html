<!-- app/templates/admin/entries_list.html -->
{% extends "base.html" %}
{% block title %}Entries · Latente CMS{% endblock %}

{% block content %}
<div class="container py-4">
  <a href="/admin" class="btn btn-link p-0">&larr; Dashboard</a>

  {# ==== Contexto derivado del router ==== #}
  {% set tenant = current_tenant %}
  {% set q_section_id = request.query_params.get('section_id') %}
  {% set selected_section = None %}
  {% if q_section_id and sections_for_tenant %}
    {% for s in sections_for_tenant %}
      {% if s.id|string == q_section_id|string %}
        {% set selected_section = s %}
      {% endif %}
    {% endfor %}
  {% endif %}

  <!-- Header -->
  <section class="card z2h-card p-3 p-md-4 mt-2">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
      <div>
        <div class="z2h-brand--badge mb-1">Contenido</div>
        <h1 class="h4 m-0">
          Entries
          {% if selected_section %}
            · <span class="text-muted">{{ selected_section.name or selected_section.key }}</span>
            <span class="ms-1"><code>{{ selected_section.key }}</code></span>
          {% elif tenant %}
            · <span class="text-muted">{{ tenant.name or tenant.slug }}</span>
            <span class="ms-1 small text-muted">(elige sección con el selector)</span>
          {% else %}
            · <span class="text-muted small">Selecciona proyecto y sección para listar contenido</span>
          {% endif %}
        </h1>

        {% if tenant and selected_section %}
          <div class="mt-2 small text-muted">
            Tenant: <strong>{{ tenant.name or tenant.slug }}</strong> · Sección: <strong>{{ selected_section.name or selected_section.key }}</strong>
          </div>
        {% endif %}
      </div>

      <!-- Pickers dentro de FORM GET (robusto) -->
      <form id="pickersForm" method="get" class="d-flex flex-wrap align-items-center gap-2">
        <div class="d-flex flex-column">
          <label class="form-label m-0 small text-muted">Proyecto</label>
          <select id="tenantSelect" name="tenant_id" class="form-select form-select-sm" style="min-width: 220px;">
            <option value="">— Selecciona proyecto —</option>
            {% for t in tenants_ctx or [] %}
              <option value="{{ t.id }}" {% if tenant and t.id == tenant.id %}selected{% endif %}>
                {{ t.name or t.slug }} (id {{ t.id }})
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="d-flex flex-column">
          <label class="form-label m-0 small text-muted">Sección</label>
          <select id="sectionSelect" name="section_id" class="form-select form-select-sm" style="min-width: 240px;" {% if not tenant %}disabled{% endif %}>
            <option value="">— Selecciona sección —</option>
            {% if tenant and sections_for_tenant %}
              {% for s in sections_for_tenant %}
                <option value="{{ s.id }}" {% if selected_section and selected_section.id == s.id %}selected{% endif %}>
                  {{ s.name or s.key }} (id {{ s.id }})
                </option>
              {% endfor %}
            {% endif %}
          </select>
        </div>

        {% if selected_section %}
          <a class="btn btn-outline btn-sm" href="/admin/sections/{{ selected_section.id }}/edit">Editar sección</a>
        {% endif %}
      </form>
    </div>
  </section>

  {% if msg %}<div class="alert alert-success mt-3">{{ msg }}</div>{% endif %}

  <!-- Estados sin contexto -->
  {% if not tenant or not selected_section %}
    <div class="card z2h-card p-4 mt-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <div class="fw-semibold">Selecciona un proyecto y una sección</div>
          <div class="text-muted">Usa los selectores para cargar el contenido de una sección específica.</div>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline" href="/admin/tenants">Ir a Proyectos</a>
        </div>
      </div>
    </div>
  {% else %}

  <!-- Tabla -->
  <div class="card z2h-card p-0 mt-3">
    {% if entries and entries|length > 0 %}
      <div class="table-responsive">
        <table class="table align-middle m-0">
          <thead>
            <tr>
              <th style="width:80px;">ID</th>
              <th>Slug</th>
              <th style="width:140px;">Status</th>
              <th style="width:120px;">Schema v</th>
              <th style="width:220px;" class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for e in entries %}
            <tr>
              <td class="text-muted">{{ e.id }}</td>
              <td class="fw-semibold">{{ e.slug }}</td>
              <td><span class="z2h-badge">{{ e.status }}</span></td>
              <td>{{ e.schema_version }}</td>
              <td class="text-end">
                <div class="d-flex flex-wrap justify-content-end gap-2">
                  <a class="btn btn-sm btn-primary" href="/admin/entries/{{ e.id }}/edit">Editar</a>
                  <a class="btn btn-sm btn-outline" href="/admin/entries/{{ e.id }}/preview">Preview</a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
          <div>
            <div class="fw-semibold">Sin entries</div>
            <div class="text-muted">No hay contenido en esta sección todavía.</div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <div class="z2h-footer mt-3">
    <div class="container d-flex justify-content-between align-items-center">
      <span class="small">Latente CMS · Entries</span>
      <span class="small text-muted">
        Tenant <strong>{{ tenant.slug }}</strong> · Section <strong>{{ selected_section.key }}</strong>
      </span>
    </div>
  </div>

  {% endif %}
</div>

<style>
  .z2h-card table thead tr th { border-bottom:1px solid var(--border); }
  .z2h-badge{
    display:inline-block; padding:.25rem .5rem; border-radius:999px;
    background:#EFE9E1; border:1px solid var(--border); color:var(--text-2); font-weight:700; font-size:.78rem;
    text-transform:uppercase; letter-spacing:.06em;
  }
</style>

<script>
  (function(){
    const form = document.getElementById('pickersForm');
    const tenantSelect  = document.getElementById('tenantSelect');
    const sectionSelect = document.getElementById('sectionSelect');

    function submitForm() {
      if (!tenantSelect.value) {
        // Si limpian tenant, también limpiamos sección para no dejar basura en la URL
        sectionSelect.value = '';
      }
      form.submit(); // GET con ?tenant_id=...&section_id=...
    }

    async function loadSections(tenantId, preselectId){
      sectionSelect.disabled = true;
      sectionSelect.innerHTML = '<option value="">— Selecciona sección —</option>';
      if(!tenantId){ return; }
      try{
        const res = await fetch(`/admin/tenants/${tenantId}/sections.json`);
        const data = await res.json();
        for(const s of data){
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = `${s.name || s.key} (id ${s.id})`;
          if(preselectId && String(preselectId) === String(s.id)) opt.selected = true;
          sectionSelect.appendChild(opt);
        }
        sectionSelect.disabled = false;

        // Si NO hay section_id y sólo existe una sección, auto-submit
        const urlSection = new URLSearchParams(window.location.search).get('section_id') || '';
        if (!urlSection && data.length === 1){
          sectionSelect.value = String(data[0].id);
          submitForm();
        }
      }catch(e){
        console.error('No se pudieron cargar las secciones', e);
      }
    }

    // Init: si hay tenant pero el select viene vacío (sólo placeholder), repoblar desde JSON
    const currentTenantId  = tenantSelect?.value || '';
    const currentSectionId = new URLSearchParams(window.location.search).get('section_id') || '';

    if(currentTenantId){
      const optionsCount = sectionSelect ? sectionSelect.options.length : 1; // incluye placeholder
      if (optionsCount <= 1){
        loadSections(currentTenantId, currentSectionId);
      } else if (!currentSectionId && optionsCount === 2){
        // 1 placeholder + 1 sección -> seleccionar y enviar
        sectionSelect.selectedIndex = 1;
        submitForm();
      }
    }

    tenantSelect?.addEventListener('change', ()=>{
      // Al cambiar tenant, limpiamos sección y enviamos
      sectionSelect.value = '';
      submitForm();
    });

    sectionSelect?.addEventListener('change', ()=>{
      submitForm();
    });
  })();
</script>
{% endblock %}







<!--app/templates/admin/entry_editor.html-->
{% extends "base.html" %}
{% block title %}Editor · Latente CMS{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token or '' }}">
<style>
  /* Mini estilos específicos del editor (no toco tu style.css) */
  .z2h-editor-header{display:flex;flex-wrap:wrap;gap:.5rem 1rem;align-items:center;justify-content:space-between;margin-bottom:1rem}
  .z2h-editor-meta{display:flex;flex-wrap:wrap;gap:.5rem 1rem;align-items:center}
  .z2h-editor-form{display:grid;grid-template-columns:1fr;gap:1rem}
  .z2h-field{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1rem}
  .z2h-field label{font-weight:700;margin-bottom:.35rem;display:block}
  .z2h-field .help{color:var(--text-2);font-size:.9rem}
  .z2h-toolbar{display:flex;flex-wrap:wrap;gap:.5rem}
  .z2h-msg{margin-top:.5rem;min-height:1.75rem}
  .z2h-sticky-actions{position:sticky;bottom:0;z-index:10;background:linear-gradient(180deg, rgba(243,241,234,0) 0%, rgba(243,241,234,1) 40%);padding-top:.75rem}
  .z2h-kv{display:flex;flex-wrap:wrap;gap:.5rem 1rem}
  .z2h-kv span{background:#f6f3ee;border:1px solid var(--border);border-radius:999px;padding:.25rem .6rem}
  .z2h-code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:.9rem;background:#faf8f4;border:1px dashed var(--border);border-radius:12px;padding:.75rem;white-space:pre-wrap}
</style>
{% endblock %}

{% block content %}

<section class="card z2h-card p-3 p-md-4">
  <div class="z2h-editor-header">
    <div>
      <h1 class="h4 m-0">Editor</h1>
      <div class="text-muted">Tenant: <strong>{{ tenant.slug }}</strong> · Sección: <strong>{{ section.key }}</strong> · Entry: <code>{{ entry.slug }}</code></div>
    </div>
    <div class="z2h-toolbar">
      <button id="btn-save" class="btn btn-outline">Guardar borrador</button>
      <button id="btn-preview" class="btn btn-outline">Preview</button>
      <button id="btn-publish" class="btn btn-primary">Publicar</button>
      <button id="btn-unpublish" class="btn btn-outline">Quitar publicación</button>
      <a class="btn btn-outline" href="/admin/entries?tenant_id={{ tenant.id }}">Volver a Entries</a>
    </div>
  </div>

  <div class="z2h-editor-meta mb-3">
    <div class="z2h-kv">
      <span>entry_id: {{ entry.id }}</span>
      <span>schema_version: <span id="schema_version_badge">{{ entry.schema_version }}</span></span>
      <span>status: <span id="status_badge">{{ entry.status }}</span></span>
    </div>
  </div>

  <!-- Contenedor del formulario auto-generado -->
  <form id="autoform" class="z2h-editor-form"></form>

  <!-- JSON crudo (solo si hace falta ver/depurar) -->
  <details class="mt-3">
    <summary class="text-muted">Ver JSON actual</summary>
    <pre id="json_view" class="z2h-code"></pre>
  </details>

  <div id="msg" class="z2h-msg"></div>

  <div class="z2h-sticky-actions mt-3">
    <div class="d-flex gap-2">
      <button id="btn-save-bottom" class="btn btn-outline" type="button">Guardar borrador</button>
      <button id="btn-preview-bottom" class="btn btn-outline" type="button">Preview</button>
      <button id="btn-publish-bottom" class="btn btn-primary" type="button">Publicar</button>
    </div>
  </div>
</section>

{% endblock %}

{% block extra_scripts %}
<script>
(async () => {
  const TENANT_ID = {{ tenant.id }};
  const SECTION_ID = {{ section.id }};
  const ENTRY_ID = {{ entry.id }};
  const DELIVERY_PREVIEW_URL = '/delivery/v1/preview';

  const $form = document.getElementById('autoform');
  const $jsonView = document.getElementById('json_view');
  const $msg = document.getElementById('msg');
  const $schemaVersion = document.getElementById('schema_version_badge');
  const $status = document.getElementById('status_badge');

  // Botones
  const $saveTop = document.getElementById('btn-save');
  const $previewTop = document.getElementById('btn-preview');
  const $publishTop = document.getElementById('btn-publish');
  const $unpublishTop = document.getElementById('btn-unpublish');

  const $saveBottom = document.getElementById('btn-save-bottom');
  const $previewBottom = document.getElementById('btn-preview-bottom');
  const $publishBottom = document.getElementById('btn-publish-bottom');

  const showMsg = (text, ok=true) => {
    $msg.textContent = text;
    $msg.className = 'z2h-msg ' + (ok ? 'text-success' : 'text-danger');
    setTimeout(()=>{ $msg.textContent=''; $msg.className='z2h-msg'; }, 3200);
  };

  // 1) Cargar contrato UI + entry
  async function fetchUiContract() {
    const res = await fetch(`/api/v1/schemas/${SECTION_ID}/active/ui?tenant_id=${TENANT_ID}`);
    if (!res.ok) throw new Error('No se pudo obtener el contrato UI');
    return await res.json();
  }
  async function fetchEntry() {
    const res = await fetch(`/api/v1/editor/entries/${ENTRY_ID}?tenant_id=${TENANT_ID}`);
    if (!res.ok) throw new Error('No se pudo obtener el entry');
    return await res.json();
  }

  // 2) Render autoform basado en fields del contrato UI
  function setValue(obj, pathArr, value) {
    let cur = obj;
    for (let i=0;i<pathArr.length-1;i++){
      const k = pathArr[i];
      if(typeof cur[k] !== 'object' || cur[k] === null) cur[k] = {};
      cur = cur[k];
    }
    cur[pathArr[pathArr.length-1]] = value;
  }
  function getValue(obj, pathArr){
    let cur = obj;
    for(const k of pathArr){
      if(cur==null) return undefined;
      cur = cur[k];
    }
    return cur;
  }

  function renderForm(contract, entryData, schemaVersion) {
    $form.innerHTML = '';
    const fields = contract.fields || [];
    const initial = JSON.parse(JSON.stringify(entryData || {}));

    // Campo de schema_version (select si hay info)
    if (contract.schema_version) {
      const wrap = document.createElement('div');
      wrap.className = 'z2h-field';
      const label = document.createElement('label');
      label.textContent = 'Schema version';
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 1;
      input.value = schemaVersion || contract.schema_version;
      input.name = '__schema_version__';
      wrap.appendChild(label);
      wrap.appendChild(input);
      $form.appendChild(wrap);
    }

    fields.forEach(f => {
      const wrap = document.createElement('div');
      wrap.className = 'z2h-field';

      const label = document.createElement('label');
      label.textContent = f.label || f.name;
      label.setAttribute('for', `f_${f.name}`);

      let input;
      const path = f.name.split('__');

      if (f.kind === 'enum' && Array.isArray(f.choices)) {
        input = document.createElement('select');
        input.className = 'form-select';
        input.id = `f_${f.name}`;
        f.choices.forEach(ch => {
          const opt = document.createElement('option');
          opt.value = ch; opt.textContent = ch;
          input.appendChild(opt);
        });
        const v = getValue(initial, path);
        if (v != null) input.value = v;
      } else if (f.kind === 'scalar') {
        input = document.createElement('input');
        input.className = 'form-control';
        input.id = `f_${f.name}`;
        input.type = f.type || 'text';
        const v = getValue(initial, path);
        if (v != null) input.value = v;
      } else if (f.kind === 'csv') {
        input = document.createElement('textarea');
        input.className = 'form-control';
        input.id = `f_${f.name}`;
        const v = getValue(initial, path);
        input.value = Array.isArray(v) ? v.join(', ') : (v || '');
        input.rows = 2;
      } else if (f.kind === 'boolean' || (f.kind === 'scalar' && f.type === 'checkbox')) {
        // por si tu contrato algún día devuelve kind boolean
        input = document.createElement('input');
        input.type = 'checkbox';
        input.id = `f_${f.name}`;
        const v = !!getValue(initial, path);
        input.checked = v;
      } else {
        // Unsupported -> muestra textarea JSON puntual de ese nodo
        input = document.createElement('textarea');
        input.className = 'form-control';
        input.id = `f_${f.name}`;
        input.rows = 4;
        const v = getValue(initial, path);
        input.value = (v == null) ? '' : JSON.stringify(v, null, 2);
      }

      wrap.appendChild(label);
      wrap.appendChild(input);

      if (f.help) {
        const help = document.createElement('div');
        help.className = 'help';
        help.textContent = f.help;
        wrap.appendChild(help);
      }

      $form.appendChild(wrap);
    });

    // actualiza visor
    $jsonView.textContent = JSON.stringify(initial, null, 2);
  }

  // 3) Recolectar datos del formulario a JSON
  function collectForm(contract) {
    const fields = contract.fields || [];
    const out = {};
    let schemaVersion = contract.schema_version || null;

    // schema_version (si presente)
    const sv = $form.querySelector('input[name="__schema_version__"]');
    if (sv) schemaVersion = parseInt(sv.value || `${schemaVersion || 1}`, 10);

    fields.forEach(f => {
      const path = f.name.split('__');
      const el = document.getElementById(`f_${f.name}`);
      if (!el) return;

      if (f.kind === 'enum') {
        setValue(out, path, el.value);
      } else if (f.kind === 'scalar') {
        if ((f.type || 'text') === 'number') {
          const num = Number(el.value);
          setValue(out, path, isNaN(num) ? null : num);
        } else if ((f.type || 'text') === 'checkbox') {
          setValue(out, path, !!el.checked);
        } else {
          setValue(out, path, el.value);
        }
      } else if (f.kind === 'csv') {
        const parts = (el.value || '').split(',').map(s => s.trim()).filter(Boolean);
        setValue(out, path, parts);
      } else {
        // nodo json “libre”
        const raw = el.value.trim();
        if (raw) {
          try {
            setValue(out, path, JSON.parse(raw));
          } catch (_e) {
            setValue(out, path, raw);
          }
        } else {
          setValue(out, path, null);
        }
      }
    });

    return { data: out, schema_version: schemaVersion || 1 };
  }

  // 4) Guardar (PUT)
  async function saveDraft(contract) {
    const payload = collectForm(contract);
    const res = await fetch(`/api/v1/editor/entries/${ENTRY_ID}?tenant_id=${TENANT_ID}`, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>({detail:'Error guardando'}));
      throw new Error(err.detail || 'Error guardando');
    }
    const saved = await res.json();
    $jsonView.textContent = JSON.stringify(saved.data, null, 2);
    $schemaVersion.textContent = saved.schema_version;
    $status.textContent = saved.status;
    showMsg('Borrador guardado');
  }

  // 5) Preview (token + nueva pestaña)
  async function openPreview() {
    const res = await fetch(`/api/v1/editor/entries/${ENTRY_ID}/preview-token?tenant_id=${TENANT_ID}`, { method:'POST' });
    if (!res.ok) throw new Error('No se pudo emitir preview token');
    const { token } = await res.json();
    // abre detalle (si tu delivery ya expone lista/detalle, podrías abrir el detalle real también)
    window.open(`${DELIVERY_PREVIEW_URL}?token=${encodeURIComponent(token)}`, '_blank');
  }

  async function publish() {
    const res = await fetch(`/api/v1/editor/entries/${ENTRY_ID}/publish?tenant_id=${TENANT_ID}`, { method:'POST' });
    if (!res.ok) {
      const err = await res.json().catch(()=>({detail:'Error al publicar'}));
      throw new Error(err.detail || 'Error al publicar');
    }
    $status.textContent = 'published';
    showMsg('¡Publicado!');
  }

  async function unpublish() {
    const res = await fetch(`/api/v1/editor/entries/${ENTRY_ID}/unpublish?tenant_id=${TENANT_ID}`, { method:'POST' });
    if (!res.ok) {
      const err = await res.json().catch(()=>({detail:'Error al despublicar'}));
      throw new Error(err.detail || 'Error al despublicar');
    }
    $status.textContent = 'draft';
    showMsg('Se quitó de publicación');
  }

  // Bootstrap de la página
  try {
    const [contract, entry] = await Promise.all([fetchUiContract(), fetchEntry()]);
    renderForm(contract, entry.data || {}, entry.schema_version);
    // Wire botones
    $saveTop.onclick = () => saveDraft(contract).catch(e=>showMsg(e.message,false));
    $saveBottom.onclick = () => saveDraft(contract).catch(e=>showMsg(e.message,false));
    $previewTop.onclick = () => openPreview().catch(e=>showMsg(e.message,false));
    $previewBottom.onclick = () => openPreview().catch(e=>showMsg(e.message,false));
    $publishTop.onclick = () => publish().catch(e=>showMsg(e.message,false));
    $publishBottom.onclick = () => publish().catch(e=>showMsg(e.message,false));
    $unpublishTop.onclick = () => unpublish().catch(e=>showMsg(e.message,false));
  } catch (e) {
    showMsg(e.message || 'Error inicializando editor', false);
  }
})();
</script>
{% endblock %}
